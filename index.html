<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escala de Trabalho - Mês Completo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls select {
      padding: 8px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .controls button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .controls button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      max-width: 700px;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px 4px;
      vertical-align: top;
      word-wrap: break-word;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .weekend {
      background-color: #f8d7da;
      color: #721c24;
    }
    .workday {
      background-color: #d4edda;
      color: #155724;
    }
    .person-name {
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #d63384;
      background-color: #f8d7da;
      border: 1px solid #f5c2c7;
      border-radius: 4px;
      margin: 20px 0;
    }

    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
      }

      thead tr {
        display: none;
      }

      tbody tr {
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
      }

      tbody tr td {
        border: none;
        padding: 6px 10px;
        position: relative;
        text-align: left;
        background: none;
        color: inherit;
      }

      tbody tr td div:first-child {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 8px;
      }

      .person-name {
        display: inline-block;
        min-width: 80px;
      }
    }
  </style>
</head>
<body>

<h1>Escala de Trabalho</h1>

<div class="controls">
  <select id="month-select">
    <option value="">Carregando...</option>
  </select>
  <button id="add-month-btn">Adicionar Mês Seguinte</button>
</div>

<div id="loading" class="loading" style="display: none;">Carregando dados...</div>
<div id="error" class="error" style="display: none;"></div>

<table>
  <thead>
    <tr>
      <th>Domingo</th>
      <th>Segunda</th>
      <th>Terça</th>
      <th>Quarta</th>
      <th>Quinta</th>
      <th>Sexta</th>
      <th>Sábado</th>
    </tr>
  </thead>
  <tbody id="calendar-body">
  </tbody>
</table>

<script>
  const gistId = 'b996dc535ebcc23c8b45f8979b4d86e0';
  const filename = 'meses_escala.json';
  const token = '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';
  
  const people = ['Pessoa 1', 'Pessoa 2'];
  const weekDayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
  let currentMonth = null;
  let currentYear = null;
  let months = [];

  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
  }

  function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  function buildCalendar(year, month) {
    const calendarBody = document.getElementById('calendar-body');
    calendarBody.innerHTML = '';

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    let date = 1;

    while (date <= lastDay.getDate()) {
      const row = document.createElement('tr');

      for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
        const cell = document.createElement('td');

        if (date > lastDay.getDate()) {
          cell.innerHTML = '';
          row.appendChild(cell);
          continue;
        }

        if (date === 1 && dayOfWeek < firstDay.getDay()) {
          cell.innerHTML = '';
          row.appendChild(cell);
          continue;
        }

        const currentDate = new Date(year, month, date);
        const currentWeekDay = currentDate.getDay();

        const dayTitle = `${weekDayNames[currentWeekDay]}, ${date}`;

        let cellContent = `<div class="day-title">${dayTitle}</div>`;

        people.forEach(person => {
          const isWeekend = (currentWeekDay === 0 || currentWeekDay === 6);
          const status = isWeekend ? 'Folga' : 'Trabalho';
          const className = isWeekend ? 'weekend' : 'workday';
          cellContent += `<div class="${className}"><span class="person-name">${person}:</span> ${status}</div>`;
        });

        cell.innerHTML = cellContent;
        row.appendChild(cell);
        date++;
      }
      calendarBody.appendChild(row);
    }
  }

  function getMonthNumber(monthName) {
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    return monthNames.indexOf(monthName);
  }

  function getMonthName(monthNumber) {
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    return monthNames[monthNumber];
  }

  function getNextMonth(month, year) {
    let nextMonth = month + 1;
    let nextYear = year;
    if (nextMonth > 11) {
      nextMonth = 0;
      nextYear++;
    }
    return { month: nextMonth, year: nextYear };
  }

  async function loadMonths() {
    try {
      showLoading(true);
      
      const response = await fetch(`https://api.github.com/gists/${gistId}`);
      
      if (!response.ok) {
        throw new Error(`Erro ao carregar gist: ${response.status}`);
      }

      const gist = await response.json();
      const file = gist.files[filename];
      
      if (file && file.content.trim()) {
        // Tenta fazer parse do JSON primeiro
        try {
          const parsedContent = JSON.parse(file.content);
          if (Array.isArray(parsedContent)) {
            months = parsedContent;
          } else {
            // Se não for array, tenta como string separada por vírgulas
            months = file.content.split(',').map(month => month.trim()).filter(month => month);
          }
        } catch (parseError) {
          // Se falhar o parse JSON, trata como string separada por vírgulas
          months = file.content.split(',').map(month => month.trim()).filter(month => month);
        }
      }

      // Se não há meses salvos, cria o mês atual
      if (months.length === 0) {
        const date = new Date();
        const monthName = getMonthName(date.getMonth());
        const monthString = `${monthName} ${date.getFullYear()}`;
        months = [monthString];
        await saveMonths();
      }

      updateMonthSelect();
      
      // Carrega o último mês da lista
      if (months.length > 0) {
        const monthSelect = document.getElementById('month-select');
        monthSelect.value = months[months.length - 1];
        loadMonth(months[months.length - 1]);
      }

    } catch (error) {
      console.error('Erro ao carregar meses:', error);
      showError('Erro ao carregar dados do servidor. Usando dados locais.');
      
      // Fallback para o mês atual se houver erro
      const date = new Date();
      const monthName = getMonthName(date.getMonth());
      const monthString = `${monthName} ${date.getFullYear()}`;
      months = [monthString];
      updateMonthSelect();
      loadMonth(months[0]);
    } finally {
      showLoading(false);
    }
  }

  function updateMonthSelect() {
    const monthSelect = document.getElementById('month-select');
    monthSelect.innerHTML = '';
    
    months.forEach(month => {
      const option = document.createElement('option');
      option.value = month;
      option.text = month;
      monthSelect.appendChild(option);
    });
  }

  
  function loadMonth(month) {
    const [monthName, year] = month.split(' ');
    const monthNumber = getMonthNumber(monthName);
    
    if (monthNumber === -1) {
      showError('Formato de mês inválido');
      return;
    }
    
    currentMonth = monthNumber;
    currentYear = parseInt(year);
    buildCalendar(currentYear, currentMonth);
  }

  async function addNextMonth() {
    try {
      const nextMonth = getNextMonth(currentMonth, currentYear);
      const monthName = getMonthName(nextMonth.month);
      const monthString = `${monthName} ${nextMonth.year}`;
      
      if (!months.includes(monthString)) {
        months.push(monthString);
        updateMonthSelect();
        await saveMonths();
      }
      
      // Seleciona o novo mês
      const monthSelect = document.getElementById('month-select');
      monthSelect.value = monthString;
      loadMonth(monthString);
      
    } catch (error) {
      console.error('Erro ao adicionar mês:', error);
      showError('Erro ao salvar novo mês');
    }
  }

  async function saveMonths() {
    try {
      const gistData = {
        files: {
          [filename]: {
            content: JSON.stringify(months, null, 2)
          }
        }
      };

	  const response = await fetch(`https://api.github.com/gists/${gistId}`, {
	    headers: {
	      'Authorization': `token ${token}`,
	      'Content-Type': 'application/json',
	      'Accept': 'application/vnd.github.v3+json'
	    }
	  });

      if (!response.ok) {
        throw new Error(`Erro ao salvar: ${response.status}`);
      }

      console.log('Meses salvos com sucesso!');
      
    } catch (error) {
      console.error('Erro ao salvar meses:', error);
      showError('Erro ao salvar dados no servidor');
      throw error;
    }
  }

  // Event listeners
  document.getElementById('add-month-btn').addEventListener('click', addNextMonth);
  document.getElementById('month-select').addEventListener('change', (e) => {
    if (e.target.value) {
      loadMonth(e.target.value);
    }
  });

  // Inicialização
  loadMonths();
</script>

</body>
</html>
