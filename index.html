<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escala de Trabalho - Mês Completo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .token {
      text-align: center;
      margin-bottom: 20px;
    }

    .token button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .token button:hover {
      background-color: #0056b3;
    }

    .token input {
      text-align: center;
      width: 700px;
      max-width: 90%;
      height: 25px;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls select {
      padding: 8px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .controls button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .controls button:hover {
      background-color: #0056b3;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .form-group textarea {
      height: 150px;
      resize: vertical;
    }

    .person-selection {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .person-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .person-option input[type="radio"] {
      width: auto;
    }

    .date-selection {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .date-selection select {
      flex: 1;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    table {
      width: 100%;
      max-width: 700px;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px 4px;
      vertical-align: top;
      word-wrap: break-word;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .weekend {
	  background-color: #d4edda; /* verde claro */
	  color: #155724; /* texto verde escuro */
    }
    .workday {
      background-color: #d4edda;
      color: #155724;
    }
    .cris-day-off {
	  background-color: #FFC0CB; /* rosa claro */
	}
	
	.clei-day-off {
	  background-color: #b8daff; /* azul claro */
	}
    .person-name {
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

	.alert {
	  position: relative;
	  z-index: 10000;
	  text-align: center;
	  padding: 20px;
	  border-radius: 4px;
	  margin: 20px 0;
	}
	
	.error {
	  background-color: #f8d7da;
	  color: #d63384;
	  border: 1px solid #f5c2c7;
	}
	
	.success {
	  background-color: #ADD8E6;
	  color: #000;
	}

    @media (max-width: 600px) {
      .modal-content {
        margin: 2% auto;
        width: 95%;
      }
      
      .person-selection {
        flex-direction: column;
        gap: 10px;
      }
      
      .date-selection {
        flex-direction: column;
      }
      
      table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
      }

      thead tr {
        display: none;
      }

      tbody tr {
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
      }

      tbody tr td {
        border: none;
        padding: 6px 10px;
        position: relative;
        text-align: left;
        background: none;
        color: inherit;
      }

      tbody tr td div:first-child {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 8px;
      }

      .person-name {
        display: inline-block;
        min-width: 80px;
      }
    }
  </style>
</head>
<body>

<h1>Escala de Trabalho</h1>

<div class="token">
  <input type="password" id="tokenInput" placeholder="Insira o token">
  <button onclick="usarToken()" id="executar-btn">Executar</button>
</div>

<div class="controls">
  <select id="month-select">
    <option value="">Carregando...</option>
  </select>
  <button id="add-schedule-btn">Adicionar Escala</button>
</div>

<div id="loading" class="loading" style="display: none;">Carregando dados...</div>
<div id="error" class="error" style="display: none;"></div>

<table>
  <thead>
    <tr>
      <th>Domingo</th>
      <th>Segunda</th>
      <th>Terça</th>
      <th>Quarta</th>
      <th>Quinta</th>
      <th>Sexta</th>
      <th>Sábado</th>
    </tr>
  </thead>
  <tbody id="calendar-body">
  </tbody>
</table>

<!-- Modal para adicionar escala -->
<div id="scheduleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Adicionar Escala</h2>
      <span class="close">&times;</span>
    </div>
    
    <div class="form-group">
      <label>Selecione a pessoa:</label>
      <div class="person-selection">
        <div class="person-option">
		  <input type="radio" id="cris" name="pessoa" value="Cris">
		  <label for="cris">Cris</label>
		</div>
		<div class="person-option">
		  <input type="radio" id="clei" name="pessoa" value="Clei">
		  <label for="clei">Clei</label>
		</div>
      </div>
    </div>

    <div class="form-group">
      <label>Período da escala:</label>
      <div class="date-selection">
        <select id="schedule-month">
          <option value="">Selecione o mês</option>
        </select>
        <select id="schedule-year">
          <option value="">Selecione o ano</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="schedule-table">Cole a tabela de escala ou sequência separada por ",":</label>
      <textarea id="schedule-table" placeholder="Cole aqui a tabela HTML da escala..."></textarea>
    </div>

    <div class="modal-buttons">
      <button class="btn-secondary" id="cancel-btn">Cancelar</button>
      <button class="btn-primary" id="save-schedule-btn">Salvar Escala</button>
    </div>
  </div>
</div>

<script>
//script página escala de trabalho - v3 corrigido para regras de folga
const gistId = 'b996dc535ebcc23c8b45f8979b4d86e0';
const filename = 'escalas_trabalho.json';

const people = ['Cris', 'Clei'];
const weekDayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
let currentMonth = null;
let currentYear = null;
let schedules = {};
let token = '';

// --- Funções de Interação com UI --- 

function showLoading(show) {
  const loadingDiv = document.getElementById('loading');
  if (loadingDiv) {
    loadingDiv.style.display = show ? 'block' : 'none';
  }
}


function showError(message) {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = message;
  errorDiv.className = 'alert error';
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }
}



function updateUIBasedOnToken(isValid) {
    const tokenDiv = document.querySelector('.token');
    const controlsDiv = document.querySelector('.controls');
    const calendarTable = document.querySelector('table');

    if (isValid) {
        if (tokenDiv) tokenDiv.style.display = 'none';
        if (controlsDiv) controlsDiv.style.display = 'block';
        if (calendarTable) calendarTable.style.display = 'table';
    } else {
        if (tokenDiv) tokenDiv.style.display = 'block';
        if (controlsDiv) controlsDiv.style.display = 'none';
        if (calendarTable) calendarTable.style.display = 'none';
    }
}

// --- Funções de Lógica e API --- 

function usarToken() {
  token = document.getElementById('tokenInput').value;
  if (token) {
    verificarToken()
    .then(tokenValido => {
      if (tokenValido) {
        localStorage.setItem('githubToken', token);
        loadSchedules();
        verificarTokenPeriodicamente();
        updateUIBasedOnToken(true);
      } else {
        localStorage.removeItem('githubToken');
        showError('Token inválido. Por favor, verifique o token informado.');
        updateUIBasedOnToken(false);
      }
    });
  } else {
    localStorage.removeItem('githubToken');
    showError('Por favor, informe o token.');
    updateUIBasedOnToken(false);
  }
}

let tokenCheckIntervalId = null;

function verificarTokenPeriodicamente() {
  if (tokenCheckIntervalId) clearInterval(tokenCheckIntervalId);

  tokenCheckIntervalId = setInterval(async () => {
    if (!token) {
        clearInterval(tokenCheckIntervalId);
        tokenCheckIntervalId = null;
        return;
    }
    try {
      const response = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (!response.ok) {
        mostrarMensagemTokenExpirado();
        clearInterval(tokenCheckIntervalId);
        tokenCheckIntervalId = null;
        updateUIBasedOnToken(false);
      }
    } catch (error) {
      console.error('Erro ao verificar token periodicamente:', error);
    }
  }, 5 * 60 * 1000);
}

function mostrarMensagemTokenExpirado() {
  showError('Token expirado ou inválido. Por favor, informe um novo token.');
}

function verificarToken() {
  showLoading(true);
  return fetch('https://api.github.com/user', {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  })
  .then(response => response.ok)
  .catch(error => {
    console.error('Erro ao verificar token:', error);
    showError('Erro de rede ao verificar o token.');
    return false;
  })
  .finally(() => showLoading(false));
}

function buildCalendar(year, month) {
  if (!token) {
    showError('Token não definido. Por favor, informe o token.');
    return;
  }

  const calendarBody = document.getElementById('calendar-body');
  if (!calendarBody) {
      console.error("Elemento 'calendar-body' não encontrado!");
      return;
  }
  calendarBody.innerHTML = '';

  const firstDayOfMonth = new Date(year, month, 1);
  const lastDayOfMonth = new Date(year, month + 1, 0);
  const daysInMonth = lastDayOfMonth.getDate();
  const startDayOfWeek = firstDayOfMonth.getDay();

  const monthKey = `${getMonthName(month)} ${year}`;

  let date = 1;
  let row = document.createElement('tr');

  for (let i = 0; i < startDayOfWeek; i++) {
    const cell = document.createElement('td');
    cell.classList.add('empty');
    row.appendChild(cell);
  }

  while (date <= daysInMonth) {
    const dayOfWeek = (startDayOfWeek + date - 1) % 7;

    if (dayOfWeek === 0 && row.children.length > 0) {
      calendarBody.appendChild(row);
      row = document.createElement('tr');
    }

    const cell = document.createElement('td');
    let cellContent = `<div class="day-title">${date}</div>`;

	people.forEach(person => {
	  let status = '';
	  let className = 'workday';
	
	  if (schedules[person] && schedules[person][monthKey]) {
	    const dayOffList = schedules[person][monthKey];
	    if (dayOffList.includes(date)) {
	      status = 'Folga';
	      className = person.toLowerCase().replace(' ', '-') + '-day-off';
	      cellContent += `<div class="${className}"><span class="person-name">${person}:</span> ${status}</div>`;
	    }
	  }
	  
	});

    cell.innerHTML = cellContent;
    row.appendChild(cell);
    date++;
  }

  while (row.children.length < 7) {
    const cell = document.createElement('td');
    cell.classList.add('empty');
    row.appendChild(cell);
  }

  calendarBody.appendChild(row);
}

function getMonthNumber(monthName) {
  const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  return monthNames.indexOf(monthName);
}

function getMonthName(monthNumber) {
  const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  if (monthNumber >= 0 && monthNumber < 12) {
      return monthNames[monthNumber];
  }
  return '';
}

async function loadSchedules() {
  try {
    showLoading(true);
    schedules = {};

    const response = await fetch(`https://api.github.com/gists/${gistId}`);

    if (!response.ok) {
      if (response.status === 404) {
         console.warn(`Gist ${gistId} não encontrado. Iniciando com dados vazios.`);
      } else {
          throw new Error(`Erro ao carregar gist: ${response.status}`);
      }
    } else {
        const gist = await response.json();
        const file = gist.files[filename];

        if (file && file.content && file.content.trim()) {
          try {
            schedules = JSON.parse(file.content);
            console.log("Escalas carregadas:", schedules);
          } catch (parseError) {
            console.error('Erro ao fazer parse das escalas:', parseError);
            showError('Erro ao ler os dados de escala salvos. Verifique o formato no Gist.');
          }
        } else {
            console.log("Arquivo de escalas vazio ou não encontrado no Gist. Iniciando com dados vazios.");
        }
    }

    updateMonthSelect();

    const monthSelect = document.getElementById('month-select');
    let monthToLoad = monthSelect.value;

    if (!monthToLoad) {
        const date = new Date();
        const currentMonthName = getMonthName(date.getMonth());
        const currentYearNum = date.getFullYear();
        monthToLoad = `${currentMonthName} ${currentYearNum}`;
        
        if (!Array.from(monthSelect.options).some(opt => opt.value === monthToLoad)) {
            const option = document.createElement('option');
            option.value = monthToLoad;
            option.text = monthToLoad;
            if (monthSelect.options.length > 1) {
                monthSelect.insertBefore(option, monthSelect.options[1]);
            } else {
                monthSelect.appendChild(option);
            }
        }
        monthSelect.value = monthToLoad;
    }
    
    loadMonth(monthToLoad);

  } catch (error) {
    console.error('Erro ao carregar escalas:', error);
    showError(`Erro ao carregar dados do Gist: ${error.message}`);
    schedules = {};
    updateMonthSelect();
    loadMonth(null);
  } finally {
    showLoading(false);
  }
}

function updateMonthSelect() {
  const monthSelect = document.getElementById('month-select');
  if (!monthSelect) return;
  const currentSelection = monthSelect.value;
  monthSelect.innerHTML = '';

  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.text = 'Selecione o Mês/Ano';
  defaultOption.disabled = true;
  monthSelect.appendChild(defaultOption);

  const months = new Set();
  Object.values(schedules).forEach(personSchedules => {
    if (personSchedules) {
        Object.keys(personSchedules).forEach(monthKey => {
            months.add(monthKey);
        });
    }
  });

  const date = new Date();
  const currentMonthKey = `${getMonthName(date.getMonth())} ${date.getFullYear()}`;
  months.add(currentMonthKey);

  const sortedMonths = Array.from(months).sort((a, b) => {
    const [monthA, yearA] = a.split(' ');
    const [monthB, yearB] = b.split(' ');
    const dateA = new Date(parseInt(yearA), getMonthNumber(monthA));
    const dateB = new Date(parseInt(yearB), getMonthNumber(monthB));
    if (!isNaN(dateA) && !isNaN(dateB)) {
        return dateA - dateB;
    }
    return 0;
  });

  sortedMonths.forEach(month => {
    const option = document.createElement('option');
    option.value = month;
    option.text = month;
    monthSelect.appendChild(option);
  });

  if (sortedMonths.includes(currentSelection)) {
      monthSelect.value = currentSelection;
  } else if (sortedMonths.includes(currentMonthKey)) {
      monthSelect.value = currentMonthKey;
  } else if (sortedMonths.length > 0) {
      monthSelect.value = sortedMonths[0]; 
  } else {
      monthSelect.value = ''; 
  }
  monthSelect.disabled = monthSelect.options.length <= 1;
}

function loadMonth(monthYearString) {
  const calendarBody = document.getElementById('calendar-body');
  if (!calendarBody) return;

  if (!monthYearString) {
      calendarBody.innerHTML = '';
      currentMonth = null;
      currentYear = null;
      return;
  }
  const parts = monthYearString.split(' ');
  if (parts.length !== 2) {
      showError('Formato de mês/ano inválido na seleção.');
      return;
  }
  const [monthName, yearStr] = parts;
  const monthNumber = getMonthNumber(monthName);
  const year = parseInt(yearStr);

  if (monthNumber === -1 || isNaN(year)) {
    showError('Mês ou ano inválido na seleção.');
    return;
  }

  currentMonth = monthNumber;
  currentYear = year;

  console.log(`Carregando calendário para: ${monthName} ${year}`);
  buildCalendar(currentYear, currentMonth);
}

// *** FUNÇÃO CORRIGIDA - v3 ***
function parseScheduleTable(htmlTable) {
  const tabela = document.createElement('table');
  tabela.innerHTML = htmlTable;
  const linhas = tabela.getElementsByTagName('tr');
  const diasDeFolga = [];

  let mesAtual = null;

  for (let i = 0; i < linhas.length; i++) {
    const linha = linhas[i];
    const celulas = linha.getElementsByTagName('td');

    for (let j = 0; j < celulas.length; j++) {
      const celula = celulas[j];
      let dia = null;
      let conteudo = null;

      if (celula.getElementsByTagName('a').length > 0) {
        const link = celula.getElementsByTagName('a')[0];
        conteudo = link.innerHTML.split('<br>');
        dia = conteudo[0].replace(/[^0-9]/g, '');
      } else {
        conteudo = celula.innerHTML.split('<br>');
        dia = conteudo[0].trim();
      }

      if (i === 0 && j < 2) {
        // verificar se é dia do mês anterior
        if (parseInt(dia) > 20) {
          continue;
        }
      }

      // verificar se tem horário
      const horarios = conteudo.slice(1).filter(h => h.trim().match(/^\d{1,2}:\d{2}$/));
      if (horarios.length === 0 && dia !== null && dia !== '') {
        diasDeFolga.push(`Folga dia ${dia}`);
      }
    }
  }

  return diasDeFolga;
}

function parseScheduleText(text) {
  const daysOff = text.split(',').map(day => parseInt(day.trim()));
  return daysOff.filter(day => !isNaN(day));
}

// seleciona um dos o
function extractDaysOffFromInput(input) {
  if (input.startsWith('<table')) {
    return parseScheduleTable(input);
  } else {
    return parseScheduleText(input);
  }
}



async function saveSchedulesToGist() {
  if (!token) {
      showError('Token não definido. Não é possível salvar.');
      return Promise.reject('Token não definido');
  }
  showLoading(true);
  try {
    const contentToSave = JSON.stringify(schedules || {}, null, 2);

    const gistData = {
      files: {
        [filename]: {
          content: contentToSave
        }
      }
    };

    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });

    if (!response.ok) {
      if (response.status === 404) {
          console.warn(`Gist ${gistId} não encontrado ao tentar salvar. Tentando criar...`);
          // Implementar createGist() se necessário
          throw new Error(`Gist ${gistId} não encontrado. Crie o Gist manualmente ou implemente a criação automática.`);
      }
      const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido ao salvar.' }));
      throw new Error(`Erro ${response.status}: ${errorData.message || 'Não foi possível salvar as escalas no Gist.'}`);
    }

    console.log('Escalas salvas com sucesso no Gist existente!');
    return Promise.resolve();

  } catch (error) {
    console.error('Erro ao salvar escalas no Gist:', error);
    showError(`Erro ao salvar escalas: ${error.message}`);
    throw error;
  } finally {
      showLoading(false);
  }
}

// --- Funções do Modal --- 

function openScheduleModal() {
  const modal = document.getElementById('scheduleModal');
  if (!modal) return;

  const monthSelect = document.getElementById('schedule-month');
  const yearSelect = document.getElementById('schedule-year');

  if (!monthSelect || !yearSelect) {
      console.error("Elementos select de mês/ano do modal não encontrados!");
      return;
  }

  monthSelect.innerHTML = '<option value="">Selecione o mês</option>';
  yearSelect.innerHTML = '<option value="">Selecione o ano</option>';

  const currentMonthNum = new Date().getMonth();
  for (let i = 0; i < 12; i++) {
    const option = document.createElement('option');
    option.value = getMonthName(i);
    option.text = getMonthName(i);
    monthSelect.appendChild(option);
  }
  monthSelect.value = getMonthName(currentMonthNum);

  const currentYearNum = new Date().getFullYear();
  for (let year = currentYearNum; year <= currentYearNum + 2; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.text = year;
    yearSelect.appendChild(option);
  }
   yearSelect.value = currentYearNum;

  document.querySelectorAll('input[name="pessoa"]').forEach(radio => radio.checked = false);

  const scheduleTableTextarea = document.getElementById('schedule-table');
  if (scheduleTableTextarea) scheduleTableTextarea.value = '';

  modal.style.display = 'block';
}

function closeScheduleModal() {
  const modal = document.getElementById('scheduleModal');
  if (modal) {
      modal.style.display = 'none';
  }
}

function showSuccess(message) {
  const successDiv = document.createElement('div');
  successDiv.textContent = message;
  successDiv.className = 'alert success';
  successDiv.style.backgroundColor = '#ADD8E6'; 
  successDiv.style.color = '#000'; 
  successDiv.style.padding = '10px';
  successDiv.style.borderRadius = '5px';
  successDiv.style.textAlign = 'center';
  successDiv.style.margin = '20px 0';
  successDiv.style.position = 'relative';
  successDiv.style.zIndex = '10000';

  const errorDiv = document.getElementById('error');
  if (errorDiv) {
    errorDiv.parentNode.insertBefore(successDiv, errorDiv);
    setTimeout(() => {
      successDiv.remove();
    }, 7000);
  }
}

async function saveSchedule() {
  showLoading(true);
  try {
    const selectedPersonRadio = document.querySelector('input[name="pessoa"]:checked');
    const selectedMonth = document.getElementById('schedule-month').value;
    const selectedYear = document.getElementById('schedule-year').value;
    const tableContent = document.getElementById('schedule-table').value.trim();

    if (!selectedPersonRadio) {
      showError('Por favor, selecione uma pessoa.');
      showLoading(false);
      return;
    }
    const person = selectedPersonRadio.value;

    if (!selectedMonth || !selectedYear) {
      showError('Por favor, selecione o mês e ano.');
      showLoading(false);
      return;
    }

    if (!tableContent) {
      showError('Por favor, cole a tabela de escala.');
      showLoading(false);
      return;
    }

    const monthKey = `${selectedMonth} ${selectedYear}`;
    const year = parseInt(selectedYear);
    const monthNumber = getMonthNumber(selectedMonth);

    if (schedules[person] && schedules[person][monthKey]) {
      if (!confirm(`Já existe uma escala para ${person} em ${monthKey}. Deseja substituir?`)) {
        showLoading(false);
        return;
      }
      console.log(`Substituindo escala existente para ${person} em ${monthKey}`);
    }

    // Chama a função CORRIGIDA para extrair folgas
    const daysOff = extractDaysOffFromInput(tableContent);


    if (daysOff.length === 0) {
      if (!confirm('Nenhum dia de folga foi identificado na tabela. Isso está correto? Se sim, a escala será salva sem folgas para este mês.')) {
          showError('Extração de folgas cancelada ou falhou. Verifique a tabela.');
          showLoading(false);
          return;
      }
      console.warn(`Nenhum dia de folga extraído para ${person} em ${monthKey}. Salvando escala sem folgas.`);
    }

    if (!schedules[person]) {
      schedules[person] = {};
    }
    schedules[person][monthKey] = daysOff;
    console.log(`Escala local atualizada para ${person} em ${monthKey}:`, daysOff);

    await saveSchedulesToGist();

    updateMonthSelect();
    const mainMonthSelect = document.getElementById('month-select');
    if (mainMonthSelect) mainMonthSelect.value = monthKey;
    loadMonth(monthKey);

    closeScheduleModal();

    showSuccess(`Escala de ${person} para ${monthKey} salva com sucesso!`);

  } catch (error) {
    console.error('Erro detalhado ao salvar escala:', error);
  } finally {
      showLoading(false);
  }
}

// --- Event Listeners --- 

document.addEventListener('DOMContentLoaded', () => {
  const executarBtn = document.getElementById('executar-btn');
  const addScheduleBtn = document.getElementById('add-schedule-btn');
  const monthSelect = document.getElementById('month-select');

  // O botão 'executar-btn' já tem onclick no HTML

  if (addScheduleBtn) {
    addScheduleBtn.addEventListener('click', openScheduleModal);
  }

  if (monthSelect) {
    monthSelect.addEventListener('change', (e) => {
      loadMonth(e.target.value);
    });
  }

  const modal = document.getElementById('scheduleModal');
  if (modal) {
      const closeBtn = modal.querySelector('.close');
      const cancelBtn = document.getElementById('cancel-btn');
      const saveBtn = document.getElementById('save-schedule-btn');

      if (closeBtn) closeBtn.addEventListener('click', closeScheduleModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeScheduleModal);
      if (saveBtn) saveBtn.addEventListener('click', saveSchedule);

      window.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeScheduleModal();
        }
      });
  }

  updateUIBasedOnToken(false);

  const savedToken = localStorage.getItem('githubToken');
  if (savedToken) {
      document.getElementById('tokenInput').value = savedToken;
      setTimeout(usarToken, 100);
  } else {
      if(monthSelect) {
          monthSelect.innerHTML = '<option value="">Informe o token primeiro</option>';
          monthSelect.disabled = true;
      }
  }
});

</script>


</body>
</html>
