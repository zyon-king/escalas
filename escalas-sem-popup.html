

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escala de Folgas - Mês Completo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    
    /**/
    .computer-mode {
  	  width: 1000px;
  	  margin: 0 auto;
  	  font-size: 16px;
  	}
    .switch {
      position: relative;
      display: inline-block;
      width: 45px;
      height: 25px;
  	}

  	.switch input {
      opacity: 0;
      width: 0;
      height: 0;
  	}

  	.slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
  	 }

  	.slider:before {
      position: absolute;
  	  content: "";
  	  height: 19px; /* Ajuste o height da bolinha para ser um pouco menor que o switch */
  	  width: 19px; /* Ajuste o width da bolinha para ser igual ao height */
  	  left: 3px; /* Ajuste a posição esquerda da bolinha */
  	  bottom: 3px; /* Ajuste a posição inferior da bolinha */
  	  background-color: white;
  	  transition: 0.4s;
  	}
    
	input:not(:checked) + .slider {
	  background-color: #1abc9c; /* Cor do switch desligado */
	}
    
    input:checked + .slider {
      background-color: #2196F3;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .slider.round {
      border-radius: 20px;
    }

    .slider.round:before {
      border-radius: 50%;
    }
  
  	.mode-container {
  	  display: flex;
  	  align-items: center;
  	}
	
  	.mode-status {
  	  margin-left: 10px;
  	  font-size: 16px;
  	}
    
    /**/

    .token {
      text-align: center;
      margin-bottom: 20px;
    }

    .token button {
	  padding: 15px 30px;
	  background-color: #007bff;
	  color: white;
	  border: none;
	  border-radius: 8px;
	  cursor: pointer;
	  transition: all 0.3s ease;
	  font-weight: 600;
	  font-size: 20px;
	  min-width: 120px;
	}	  
	
	.token button:hover {
	  background-color: #0056b3;
	  transform: translateY(-2px);
	  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
	}

    .token input {
      text-align: center;
      width: 700px;
      max-width: 90%;
      height: 50px;
  	  margin-bottom: 15px; /* Adiciona um espaço entre o input e o botão */
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls select {
	  padding: 12px 16px;
	  margin-right: 10px;
	  border: 2px solid #e0e0e0;
	  border-radius: 8px;
	  background-color: white;
	  font-size: 16px;
	  font-weight: 500;
	  transition: all 0.3s ease;
	  min-width: 180px;
  	  margin-bottom: 15px; /* Adiciona um espaço entre o input e o botão */
	}
	
	.controls select:focus {
	  border-color: #007bff;
	  outline: none;
	  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
	}

    .controls button {
	  padding: 12px 25px;
	  background-color: #007bff;
	  color: white;
	  border: none;
	  border-radius: 8px;
	  cursor: pointer;
	  transition: all 0.3s ease;
	  font-weight: 600;
	  font-size: 20px;
	  min-width: 140px;
	}
	
	.controls button:hover {
	  background-color: #0056b3;
	  transform: translateY(-2px);
	  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
	}

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
  	  background-color: white;
  	  margin: 1% auto;
  	  padding: 20px;
  	  border-radius: 8px;
  	  width: 90%;
  	  max-width: 750px; /* Ajustado para caber calendário */
  	  max-height: 95vh;
  	  overflow-y: auto;
    }


    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    
    .person-selection label, .date-selection label {
      font-weight: bold;
      font-size: 18px; /* Aumente o tamanho da fonte */
	}
    
    /* Ajuste para label do modal antigo, se necessário, mas o ID mudou */
    #modalSelecaoPessoaMesAno label {
  	  font-size: 18px; /* Ajustado para consistência */
    }
      
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px; /* Aumente o espaçamento interno */
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px; /* Ajustado para consistência */
    }

    .form-group textarea {
      height: 150px;
      resize: vertical;
    }
    
    .person-selection {
	  display: flex;
	  gap: 20px;
	  margin-bottom: 15px;
	}
	
	.person-option {
	  display: flex;
	  align-items: center; /* Garante alinhamento vertical */
	  gap: 8px;
	}
	
	.person-option input[type="radio"] {
	  width: 20px; /* 25px pode ser grande demais para alinhar com texto */
	  height: 20px;
	  margin: 0;
	  vertical-align: middle; /* importante */
	}
    .date-selection {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .date-selection select {
      flex: 1;
    }

    .modal-buttons button {
	  padding: 15px 30px;
	  margin-right: 10px; /* Reduzido para caber melhor */
      margin-left: 10px; /* Adicionado para espaçamento */
	  border: none;
	  border-radius: 8px;
	  cursor: pointer;
	  font-size: 18px; /* Ajustado */
	  transition: all 0.3s ease;
	  font-weight: 600;
	  min-width: 100px; /* Ajustado */
  	  margin-bottom: 15px; /* Adiciona um espaço entre o input e o botão */
	}
	
	.btn-primary {
	  background-color: #007bff;
	  color: white;
	}
	
	.btn-primary:hover {
	  background-color: #0056b3;
	  transform: translateY(-2px);
	  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
	}
	
	.btn-secondary {
	  background-color: #6c757d;
	  color: white;
	}
	
	.btn-secondary:hover {
	  background-color: #5a6268;
	  transform: translateY(-2px);
	  box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
	}

    table {
      padding: 8px 4px;
      width: 850px;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px 4px;
      vertical-align: top;
      word-wrap: break-word;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .weekend {
	  background-color: #d4edda; /* verde claro */
	  color: #155724; /* texto verde escuro */
    }
    .workday {
      background-color: #d4edda;
      color: #155724;
    }
    .cris-day-off {
	  background-color: #FFC0CB; /* rosa claro */
	}
	
	.clei-day-off {
	  background-color: #b8daff; /* azul claro */
	}
    .person-name {
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

	.alert {
	  position: relative;
	  z-index: 10000;
	  text-align: center;
	  padding: 20px;
	  border-radius: 4px;
	  margin: 20px 0;
	}
	
	.error {
	  background-color: #f8d7da;
	  color: #d63384;
	  border: 1px solid #f5c2c7;
	}
	
	.success {
	  background-color: #ADD8E6;
	  color: #000;
	}
	
	/* Estilos para popups customizados */
	#customPopup {
	  display: none;
	  position: fixed;
	  z-index: 1000;
	  left: 0;
	  top: 0;
	  width: 100%;
	  height: 100%;
	  background-color: rgba(0, 0, 0, 0.5);
	}
	
	.popup-content {
	  background-color: white;
	  margin: 50px auto 0 auto;
	  padding: 20px;
	  border-radius: 8px;
	  width: 90%;
	  max-width: 400px;
	  text-align: center;
	  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
	  position: relative;
	  top: 20px;
	}
	
	@keyframes popupSlideIn {
	  from {
	    opacity: 0;
	    transform: translate(-50%, -60%);
	  }
	  to {
	    opacity: 1;
	    transform: translate(-50%, -50%);
	  }
	}
	
	.popup-content.success {
	  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
	}
	
	.popup-content.error {
	  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
	}
	
	.popup-content.confirm {
	  background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
	}
	
	.popup-icon {
	  font-size: 48px;
	  margin-bottom: 15px;
	  display: block;
	}
	
	.popup-title {
	  font-size: 22px;
	  font-weight: bold;
	  margin-bottom: 15px;
	  color: white;
	}
	
	.popup-content.confirm .popup-title {
	  color: #333;
	}
	
	.popup-message {
  	  font-size: 30px;
  	  line-height: 1.5;
  	  margin-bottom: 25px;
  	  color: white;
	}
	
	.popup-content.confirm .popup-message {
	  color: #555;
	}
	
	.popup-buttons {
	  display: flex;
	  justify-content: center;
	  gap: 15px;
	}
	
	.popup-btn {
	  padding: 12px 25px;
	  border: none;
	  border-radius: 8px;
	  font-size: 16px;
	  cursor: pointer;
	  transition: all 0.3s ease;
	  font-weight: 600;
	  min-width: 100px;
	}
	
	.popup-btn-primary {
	  background-color: #007bff;
	  color: white;
	}
	
	.popup-btn-primary:hover {
	  background-color: #0056b3;
	  transform: translateY(-2px);
	}
	
	.popup-btn-secondary {
	  background-color: #6c757d;
	  color: white;
	}
	
	.popup-btn-secondary:hover {
	  background-color: #5a6268;
	  transform: translateY(-2px);
	}
	
	.popup-btn-success {
	  background-color: #28a745;
	  color: white;
	}
	
	.popup-btn-success:hover {
	  background-color: #218838;
	  transform: translateY(-2px);
	}
    
    /* Estilos específicos para o calendário de checkboxes */
    #calendario-checkbox-container table {
        width: 100%;
        border-collapse: collapse;
    }
    #calendario-checkbox-container th, 
    #calendario-checkbox-container td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        vertical-align: middle;
    }
    #calendario-checkbox-container th {
        background-color: #f2f2f2;
    }
    #calendario-checkbox-container td {
        height: 50px; /* Altura mínima para células */
    }
    #calendario-checkbox-container .empty {
        background-color: #fafafa;
    }
    #calendario-checkbox-container label {
        display: inline-block; /* Para alinhar com checkbox */
        margin-left: 5px;
        font-weight: normal; /* Resetar bold */
        font-size: 14px; /* Tamanho da fonte do dia */
    }
     #calendario-checkbox-container input[type="checkbox"] {
        width: 16px;
        height: 16px;
        vertical-align: middle;
    }

    @media only screen and (max-width: 768px) {
    
  	  #calendar-body td {
  	    font-size: 12px; /* Defina o tamanho da fonte desejado */
  	  }
  	  table {
  	    width: 100%;
  	    font-size: 16px; /* Ajuste o tamanho da fonte para melhor legibilidade */
  	  }
  	  table thead th {
    	font-size: 11px; /* Defina o tamanho da fonte  */
	    padding: 5px; /* Ajuste o espaçamento entre células */
	  }
	  th, td {
	    padding: 10px; /* Ajuste o espaçamento entre células */
	  }
	  .controls {
	    width: 100%; /* Ocupa toda a largura da tela */
	    padding: 10px; /* Ajuste o espaçamento */
	  }
	  
	  .token {
	    width: 100%; /* Ocupa toda a largura da tela */
	    padding: 10px; /* Ajuste o espaçamento */
	  }
      .modal-content {
        width: 95%; /* Aumenta largura em telas menores */
        max-width: 95%;
      }
      #calendario-checkbox-container td {
        height: auto; /* Altura automática em mobile */
        padding: 5px;
      }
       #calendario-checkbox-container label {
         font-size: 12px;
       }
       #calendario-checkbox-container input[type="checkbox"] {
        width: 14px;
        height: 14px;
       }
	}
    
  </style>
</head>
<body>

<div class="mode-container">
  <label class="switch">
    <input type="checkbox" id="mode-toggle">
    <span class="slider round"></span>
  </label>
  <span class="mode-status" id="mode-status">Mode</span>
</div>

<h1>Escala de Folgas</h1>

<div class="token">
  <input type="password" id="tokenInput" placeholder="Insira o token">
  <button onclick="usarToken()" id="executar-btn">Executar</button>
</div>

<div class="controls">
  <select id="month-select">
    <option value="">Carregando...</option>
  </select>
  <button id="add-schedule-btn">Adicionar Folgas</button>
</div>

<div id="loading" class="loading" style="display: none;">Carregando dados...</div>
<div id="error" class="error" style="display: none;"></div>

<table>
  <thead>
    <tr>
      <th>Dom</th>
      <th>Seg</th>
      <th>Ter</th>
      <th>Qua</th>
      <th>Qui</th>
      <th>Sex</th>
      <th>Sáb</th>
    </tr>
  </thead>
  <tbody id="calendar-body">
  </tbody>
</table>

<!-- Modal 1: Seleção Pessoa e Período (Antigo scheduleModal modificado) -->
<div id="modalSelecaoPessoaMesAno" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Selecionar Pessoa e Período</h2>
      <span class="close" onclick="fecharModal('modalSelecaoPessoaMesAno')">&times;</span>
    </div>
    
    <div class="form-group">
      <label>Selecione a pessoa:</label>
      <div class="person-selection">
        <div class="person-option">
		  <input type="radio" id="cris" name="pessoa" value="Cris">
		  <label for="cris">Cris</label>
		</div>
		<div class="person-option">
		  <input type="radio" id="clei" name="pessoa" value="Clei">
		  <label for="clei">Clei</label>
		</div>
      </div>
    </div>

    <div class="form-group">
      <label>Período da escala:</label>
      <div class="date-selection">
        <select id="schedule-month">
          <option value="">Selecione o mês</option>
          <!-- Opções de mês serão populadas via JS -->
        </select>
        <select id="schedule-year">
          <option value="">Selecione o ano</option>
          <!-- Opções de ano serão populadas via JS -->
        </select>
      </div>
    </div>

    <!-- Seção do textarea removida -->

    <div class="modal-buttons">
      <button class="btn-secondary" id="cancel-selecao-btn" onclick="fecharModal('modalSelecaoPessoaMesAno')">Cancelar</button>
      <button class="btn-primary" id="avancar-para-calendario-btn" onclick="avancarParaCalendario()">Avançar</button>
    </div>
  </div>
</div>






<!-- Modal 2: Calendário com Checkboxes -->
<div id="modalCalendarioDias" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalCalendarioTitulo">Selecionar Dias de Folga</h2>
      <span class="close" onclick="fecharModal('modalCalendarioDias')">&times;</span>
    </div>
    <div id="calendario-checkbox-container" class="form-group">
      <!-- O calendário com checkboxes será gerado aqui via JavaScript -->
      <p>Carregando calendário...</p>
    </div>
    <div class="form-group">
        <a href="#" id="linkTabelaHtml" style="text-decoration: underline; color: blue; cursor: pointer;">Prefere adicionar tabela HTML?</a>
    </div>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="fecharModal('modalCalendarioDias')">Cancelar</button>
      <button class="btn-primary" id="salvarDiasCheckboxBtn">Salvar Folgas</button>
    </div>
  </div>
</div>




<!-- Modal 3: Input Tabela HTML -->
<div id="modalTabelaHtml" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Adicionar Folgas via Tabela/Texto</h2>
      <span class="close" onclick="fecharModal('modalTabelaHtml')">&times;</span>
    </div>
    <div class="form-group">
      <label for="tabelaHtmlInput">Cole a tabela HTML da escala ou sequência separada por ",":</label>
      <textarea id="tabelaHtmlInput" rows="10"></textarea>
      <small>EXEMPLO:
        <pre>
    &lt;tbody&gt;
      &lt;tr style=\"height: 18px;\"&gt;
        &lt;td style=\"width: 12.5%; height: 18px;\"&gt;Domingo&lt;/td&gt;
        ...
    ou 14, 21, 28
        </pre>
      </small>
    </div>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="fecharModal('modalTabelaHtml')">Cancelar</button>
      <button class="btn-primary" id="salvarTabelaHtmlBtn">Salvar Folgas</button>
    </div>
  </div>
</div>




<script>
//script página escala de trabalho - v3 corrigido para regras de folga
const gistId = 'b996dc535ebcc23c8b45f8979b4d86e0';
const filename = 'escalas_trabalho.json';

const people = ['Cris', 'Clei'];
const weekDayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
let currentMonth = null;
let currentYear = null;
let schedules = {};
let token = '';

// --- Funções de Interação com UI --- 


// Start of computer mode function
const modeToggle = document.getElementById('mode-toggle');
const modeStatus = document.getElementById('mode-status');

// Verifica se o modo computador está ativado inicialmente
if (document.body.classList.contains('computer-mode')) {
  modeToggle.checked = true;
  modeStatus.textContent = 'Modo Computador ON';
} else {
  modeStatus.textContent = 'Modo Mobile ON';
}

modeToggle.addEventListener('change', () => {
  if (modeToggle.checked) {
    document.body.classList.add('computer-mode');
    modeStatus.textContent = 'Modo Computador ON';
  } else {
    document.body.classList.remove('computer-mode');
    modeStatus.textContent = 'Modo Mobile ON';
  }
});
// End of computer mode function

function showLoading(show) {
  const loadingDiv = document.getElementById('loading');
  if (loadingDiv) {
    loadingDiv.style.display = show ? 'block' : 'none';
  }
}

function updateUIBasedOnToken(isValid) {
    const tokenDiv = document.querySelector('.token');
    const controlsDiv = document.querySelector('.controls');
    const calendarTable = document.querySelector('table');

    if (isValid) {
        if (tokenDiv) tokenDiv.style.display = 'none';
        if (controlsDiv) controlsDiv.style.display = 'block';
        if (calendarTable) calendarTable.style.display = 'table';
    } else {
        if (tokenDiv) tokenDiv.style.display = 'block';
        if (controlsDiv) controlsDiv.style.display = 'none';
        if (calendarTable) calendarTable.style.display = 'none';
    }
}

// --- Funções de Lógica e API --- 

function usarToken() {
  token = document.getElementById('tokenInput').value;
  if (token) {
    verificarToken()
    .then(tokenValido => {
      if (tokenValido) {
        localStorage.setItem('githubToken', token);
        loadSchedules();
        verificarTokenPeriodicamente();
        updateUIBasedOnToken(true);
      } else {
        localStorage.removeItem('githubToken');
        showError('Token inválido. Por favor, verifique o token informado.');
        updateUIBasedOnToken(false);
      }
    });
  } else {
    localStorage.removeItem('githubToken');
    showError('Por favor, informe o token.');
    updateUIBasedOnToken(false);
  }
}

let tokenCheckIntervalId = null;

function verificarTokenPeriodicamente() {
  if (tokenCheckIntervalId) clearInterval(tokenCheckIntervalId);

  tokenCheckIntervalId = setInterval(async () => {
    if (!token) {
        clearInterval(tokenCheckIntervalId);
        tokenCheckIntervalId = null;
        return;
    }
    try {
      const response = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (!response.ok) {
        mostrarMensagemTokenExpirado();
        clearInterval(tokenCheckIntervalId);
        tokenCheckIntervalId = null;
        updateUIBasedOnToken(false);
      }
    } catch (error) {
      console.error('Erro ao verificar token periodicamente:', error);
    }
  }, 5 * 60 * 1000); // Verifica a cada 5 minutos
}

function mostrarMensagemTokenExpirado() {
  showError('Token expirado ou inválido. Por favor, informe um novo token.');
}

function verificarToken() {
  showLoading(true);
  return fetch('https://api.github.com/user', {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  })
  .then(response => response.ok)
  .catch(error => {
    console.error('Erro ao verificar token:', error);
    showError('Erro de rede ao verificar o token.');
    return false;
  })
  .finally(() => showLoading(false));
}

function buildCalendar(year, month) {
  if (!token) {
    showError('Token não definido. Por favor, informe o token.');
    return;
  }

  const calendarBody = document.getElementById('calendar-body');
  if (!calendarBody) {
    console.error("Elemento 'calendar-body' não encontrado!");
    return;
  }
  
  calendarBody.innerHTML = '';

  const firstDayOfMonth = new Date(year, month, 1);
  const lastDayOfMonth = new Date(year, month + 1, 0);
  const daysInMonth = lastDayOfMonth.getDate();
  const startDayOfWeek = firstDayOfMonth.getDay();

  const monthKey = `${getMonthName(month)} ${year}`;

  let date = 1;
  
  // Loop para criar as semanas (máximo 6 semanas)
  for (let week = 0; week < 6; week++) {
    const row = document.createElement('tr');
    
    // Loop para criar os 7 dias da semana
    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
      const cell = document.createElement('td');
      
      // Se é a primeira semana e ainda não chegou no primeiro dia do mês
      if (week === 0 && dayOfWeek < startDayOfWeek) {
        cell.classList.add('empty');
      }
      // Se já passou do último dia do mês
      else if (date > daysInMonth) {
        cell.classList.add('empty');
      }
      // Dia válido do mês
      else {
        let cellContent = `<div class="day-title">${date}</div>`;
        
        people.forEach(person => {
          let status = '';
          let className = 'workday'; // Default class
          
          if (schedules[person] && schedules[person][monthKey]) {
            const dayOffList = schedules[person][monthKey];
            if (dayOffList.includes(date)) {
              status = ''; // Não mostra texto, apenas cor
              className = person.toLowerCase().replace(' ', '-') + '-day-off';
              cellContent += `<div class="${className}"><span class="person-name">${person}</span> ${status}</div>`;
            }
          }
        });
        
        cell.innerHTML = cellContent;
        date++;
      }
      
      row.appendChild(cell);
    }
    
    calendarBody.appendChild(row);
    
    // Se já processamos todos os dias do mês, podemos parar
    if (date > daysInMonth) {
      break;
    }
  }
}

function getMonthNumber(monthName) {
  const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  return monthNames.indexOf(monthName);
}

function getMonthName(monthNumber) {
  const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  if (monthNumber >= 0 && monthNumber < 12) {
      return monthNames[monthNumber];
  }
  return '';
}

async function loadSchedules() {
  try {
    showLoading(true);
    schedules = {}; // Reset schedules

    const response = await fetch(`https://api.github.com/gists/${gistId}`);

    if (!response.ok) {
      if (response.status === 404) {
         console.warn(`Gist ${gistId} não encontrado. Iniciando com dados vazios.`);
         // Não lança erro, apenas inicia vazio
      } else {
          // Outros erros de API (ex: rate limit, auth)
          throw new Error(`Erro ao carregar gist: ${response.status}`);
      }
    } else {
        const gist = await response.json();
        const file = gist.files[filename];

        if (file && file.content && file.content.trim()) {
          try {
            schedules = JSON.parse(file.content);
            console.log("Escalas carregadas:", schedules);
          } catch (parseError) {
            console.error('Erro ao fazer parse das escalas:', parseError);
            showError('Erro ao ler os dados de escala salvos. Verifique o formato no Gist.');
            // Não reseta schedules aqui, pode ter carregado algo útil antes do erro
          }
        } else {
            console.log("Arquivo de escalas vazio ou não encontrado no Gist. Iniciando com dados vazios.");
        }
    }

    // Sempre atualiza o select de meses, mesmo se o Gist falhar
    updateMonthSelect();

    // Tenta carregar o mês selecionado ou o mês atual
    const monthSelect = document.getElementById('month-select');
    let monthToLoad = monthSelect.value;

    // Se nenhum mês estiver selecionado (ou o select estiver vazio), carrega o mês atual
    if (!monthToLoad) {
        const date = new Date();
        const currentMonthName = getMonthName(date.getMonth());
        const currentYearNum = date.getFullYear();
        monthToLoad = `${currentMonthName} ${currentYearNum}`;
        
        // Adiciona o mês/ano atual ao select se não existir
        if (!Array.from(monthSelect.options).some(opt => opt.value === monthToLoad)) {
            const option = document.createElement('option');
            option.value = monthToLoad;
            option.text = monthToLoad;
            // Insere antes da segunda opção (se houver) ou adiciona no final
            if (monthSelect.options.length > 1) {
                monthSelect.insertBefore(option, monthSelect.options[1]);
            } else {
                monthSelect.appendChild(option);
            }
        }
        monthSelect.value = monthToLoad; // Seleciona o mês/ano atual
    }
    
    // Carrega o calendário para o mês determinado
    loadMonth(monthToLoad);

  } catch (error) {
    console.error('Erro ao carregar escalas:', error);
    showError(`Erro ao carregar dados do Gist: ${error.message}`);
    // Em caso de erro grave, reseta tudo para um estado limpo
    schedules = {};
    updateMonthSelect(); // Atualiza o select (ficará vazio ou só com mês atual)
    loadMonth(null); // Limpa o calendário
  } finally {
    showLoading(false);
  }
}

function updateMonthSelect() {
  const monthSelect = document.getElementById('month-select');
  if (!monthSelect) return;
  const currentSelection = monthSelect.value; // Salva a seleção atual
  monthSelect.innerHTML = ''; // Limpa o select

  // Adiciona a opção padrão "Selecione..."
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.text = 'Selecione o Mês/Ano';
  defaultOption.disabled = true; // Não pode ser selecionada diretamente
  monthSelect.appendChild(defaultOption);

  // Coleta todos os meses/anos presentes nos dados carregados
  const months = new Set();
  Object.values(schedules).forEach(personSchedules => {
    if (personSchedules) { // Verifica se personSchedules não é null/undefined
        Object.keys(personSchedules).forEach(monthKey => {
            months.add(monthKey);
        });
    }
  });

  // Garante que o mês/ano atual esteja sempre na lista
  const date = new Date();
  const currentMonthKey = `${getMonthName(date.getMonth())} ${date.getFullYear()}`;
  months.add(currentMonthKey);

  // Ordena os meses/anos cronologicamente
  const sortedMonths = Array.from(months).sort((a, b) => {
    const [monthA, yearA] = a.split(' ');
    const [monthB, yearB] = b.split(' ');
    const dateA = new Date(parseInt(yearA), getMonthNumber(monthA));
    const dateB = new Date(parseInt(yearB), getMonthNumber(monthB));
    // Verifica se as datas são válidas antes de subtrair
    if (!isNaN(dateA) && !isNaN(dateB)) {
        return dateA - dateB;
    }
    return 0; // Mantém a ordem original se houver erro de parse
  });

  // Adiciona os meses ordenados ao select
  sortedMonths.forEach(month => {
    const option = document.createElement('option');
    option.value = month;
    option.text = month;
    monthSelect.appendChild(option);
  });

  // Restaura a seleção anterior se ainda existir, senão seleciona o mês atual ou o primeiro
  if (sortedMonths.includes(currentSelection)) {
      monthSelect.value = currentSelection;
  } else if (sortedMonths.includes(currentMonthKey)) {
      monthSelect.value = currentMonthKey;
  } else if (sortedMonths.length > 0) {
      monthSelect.value = sortedMonths[0]; // Seleciona o mais antigo se o atual não estiver
  } else {
      monthSelect.value = ''; // Deixa "Selecione..." se não houver meses
  }
  // Desabilita o select se só houver a opção padrão
  monthSelect.disabled = monthSelect.options.length <= 1;
}

function loadMonth(monthYearString) {
  const calendarBody = document.getElementById('calendar-body');
  if (!calendarBody) return;

  // Limpa o calendário se nenhum mês/ano for fornecido
  if (!monthYearString) {
      calendarBody.innerHTML = ''; // Limpa a tabela
      currentMonth = null;
      currentYear = null;
      return;
  }
  // Extrai mês e ano da string
  const parts = monthYearString.split(' ');
  if (parts.length !== 2) {
      showError('Formato de mês/ano inválido na seleção.');
      return;
  }
  const [monthName, yearStr] = parts;
  const monthNumber = getMonthNumber(monthName);
  const year = parseInt(yearStr);

  // Valida mês e ano
  if (monthNumber === -1 || isNaN(year)) {
    showError('Mês ou ano inválido na seleção.');
    return;
  }

  // Atualiza as variáveis globais
  currentMonth = monthNumber;
  currentYear = year;

  console.log(`Carregando calendário para: ${monthName} ${year}`);
  // Constrói e exibe o calendário
  buildCalendar(currentYear, currentMonth);
}

// *** FUNÇÃO CORRIGIDA - v3 ***
// Função para extrair dias de folga de uma tabela HTML (baseada na estrutura fornecida)
function parseScheduleTable(htmlTable) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlTable;
    const tableBody = tempDiv.querySelector('tbody'); // Procura dentro do tbody
    if (!tableBody) {
        console.warn('Nenhum tbody encontrado na tabela HTML fornecida.');
        return [];
    }

    const rows = tableBody.getElementsByTagName('tr');
    const daysOff = [];

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            let dayNumberStr = '';
            let cellHtml = cell.innerHTML;

            // Tenta extrair o número do dia (pode estar dentro de <a> ou direto)
            const link = cell.querySelector('a');
            if (link) {
                // Se houver link, pega o conteúdo antes do primeiro <br>
                const linkContent = link.innerHTML.split('<br>')[0];
                dayNumberStr = linkContent.replace(/[^0-9]/g, ''); // Remove não-números
            } else {
                // Se não houver link, pega o conteúdo antes do primeiro <br>
                const cellContent = cellHtml.split('<br>')[0];
                dayNumberStr = cellContent.trim(); // Pega o número direto
            }

            // Valida se é um número de dia válido
            const dayNumber = parseInt(dayNumberStr);
            if (!isNaN(dayNumber) && dayNumber >= 1 && dayNumber <= 31) {
                // Verifica se HÁ algum horário (HH:MM) no restante do conteúdo da célula
                const hasTime = /\d{1,2}:\d{2}/.test(cellHtml);
                
                // É dia de folga se NÃO houver horário
                if (!hasTime) {
                    daysOff.push(dayNumber);
                }
            }
        }
    }
    // Remove duplicados e ordena
    return [...new Set(daysOff)].sort((a, b) => a - b);
}
    
// Função para extrair dias de folga de uma string separada por vírgulas
function parseScheduleText(text) {
  const daysOff = text.split(',') // Separa por vírgula
                      .map(day => parseInt(day.trim())) // Converte para número
                      .filter(day => !isNaN(day) && day >= 1 && day <= 31); // Filtra válidos
  return [...new Set(daysOff)].sort((a, b) => a - b); // Remove duplicados e ordena
}

// Função principal para extrair dias de folga (decide entre tabela e texto)
function extractDaysOffFromInput(input) {
  const trimmedInput = input.trim();
  // Verifica se começa com '<t' (indicando tabela HTML)
  if (trimmedInput.toLowerCase().startsWith('<t')) {
    return parseScheduleTable(trimmedInput);
  } else {
    // Caso contrário, trata como texto separado por vírgulas
    return parseScheduleText(trimmedInput);
  }
}

// Função para salvar as escalas no Gist do GitHub
async function saveSchedulesToGist() {
  if (!token) {
      showError('Token não definido. Não é possível salvar.');
      return Promise.reject('Token não definido'); // Rejeita a promessa
  }
  showLoading(true);
  try {
    // Garante que schedules seja um objeto válido, mesmo que vazio
    const contentToSave = JSON.stringify(schedules || {}, null, 2);

    // Prepara os dados para a API do GitHub
    const gistData = {
      files: {
        [filename]: { // Usa o nome de arquivo definido globalmente
          content: contentToSave
        }
      }
    };

    // Faz a requisição PATCH para atualizar o Gist
    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });

    // Verifica se a atualização foi bem-sucedida
    if (!response.ok) {
      // Se o Gist não foi encontrado (404), informa o usuário
      if (response.status === 404) {
          console.warn(`Gist ${gistId} não encontrado ao tentar salvar.`);
          // Poderia tentar criar o Gist aqui se desejado
          throw new Error(`Gist ${gistId} não encontrado. Verifique o ID ou crie o Gist.`);
      }
      // Para outros erros, tenta obter a mensagem de erro da API
      const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido ao salvar.' }));
      throw new Error(`Erro ${response.status}: ${errorData.message || 'Não foi possível salvar as escalas no Gist.'}`);
    }

    console.log('Escalas salvas com sucesso no Gist existente!');
    return Promise.resolve(); // Resolve a promessa em caso de sucesso

  } catch (error) {
    console.error('Erro ao salvar escalas no Gist:', error);
    showError(`Erro ao salvar escalas: ${error.message}`);
    throw error; // Re-lança o erro para quem chamou a função saber que falhou
  } finally {
      showLoading(false); // Garante que o loading seja escondido
  }
}

// --- Funções do Modal (Antigas - podem ser removidas ou adaptadas se não usadas) --- 

// Esta função pode ser parcialmente reutilizada ou substituída pela nova lógica
/* 
function openScheduleModal() {
  const modal = document.getElementById('scheduleModal'); // ID antigo
  if (!modal) return;

  const monthSelect = document.getElementById('schedule-month');
  const yearSelect = document.getElementById('schedule-year');

  if (!monthSelect || !yearSelect) {
      console.error("Elementos select de mês/ano do modal não encontrados!");
      return;
  }

  // Limpa e popula os selects (exemplo)
  monthSelect.innerHTML = '<option value="">Selecione o mês</option>';
  yearSelect.innerHTML = '<option value="">Selecione o ano</option>';

  const currentMonthNum = new Date().getMonth();
  getMonthNamesArray().forEach((name, index) => {
    const option = document.createElement('option');
    option.value = name; 
    option.text = name;
    monthSelect.appendChild(option);
  });
  monthSelect.value = getMonthName(currentMonthNum);

  const currentYearNum = new Date().getFullYear();
  for (let year = currentYearNum; year <= currentYearNum + 2; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.text = year;
    yearSelect.appendChild(option);
  }
  yearSelect.value = currentYearNum;

  // Limpa campos
  document.getElementById('schedule-table').value = '';
  document.querySelectorAll('input[name="pessoa"]').forEach(radio => radio.checked = false);

  modal.style.display = 'block';
}
*/

// Função para popular os selects de mês/ano (usada pela nova lógica)
function populateScheduleModal() {
    const monthSelect = document.getElementById('schedule-month');
    const yearSelect = document.getElementById('schedule-year');

    if (!monthSelect || !yearSelect) return;

    // Limpa opções existentes (exceto a primeira 'Selecione...')
    // Verifica se as opções já foram populadas para evitar repopular
    if (monthSelect.options.length <= 1) {
        getMonthNamesArray().forEach((name, index) => {
            const option = document.createElement('option');
            option.value = name; // Usar nome do mês como valor
            option.text = name;
            monthSelect.appendChild(option);
        });
    }

    if (yearSelect.options.length <= 1) {
        const currentYr = new Date().getFullYear();
        for (let i = -1; i <= 2; i++) { // Adiciona ano anterior, atual e próximos 2
            const year = currentYr + i;
            const option = document.createElement('option');
            option.value = year;
            option.text = year;
            yearSelect.appendChild(option);
        }
    }
    // Não define valores padrão aqui, deixa o usuário selecionar
}

// --- Inicialização e Event Listeners --- 

document.addEventListener('DOMContentLoaded', () => {
  // Verifica token no localStorage ao carregar
  token = localStorage.getItem('githubToken');
  if (token) {
    verificarToken()
    .then(tokenValido => {
      if (tokenValido) {
        loadSchedules();
        verificarTokenPeriodicamente();
        updateUIBasedOnToken(true);
      } else {
        localStorage.removeItem('githubToken');
        showError('Token armazenado é inválido ou expirou.');
        updateUIBasedOnToken(false);
      }
    });
  } else {
    updateUIBasedOnToken(false);
  }

  // Listener para o select de mês/ano principal
  const monthSelect = document.getElementById('month-select');
  if (monthSelect) {
    monthSelect.addEventListener('change', (event) => {
      loadMonth(event.target.value);
    });
  }

  // Listener para o botão "Adicionar Folgas" (MODIFICADO PARA NOVA LÓGICA)
  const addScheduleBtn = document.getElementById('add-schedule-btn');
  if (addScheduleBtn) {
    addScheduleBtn.addEventListener('click', abrirModalSelecao); // Chama a função do novo fluxo
  }

  // Listeners para fechar modais (botão X)
  // Adicionados dinamicamente ou nos próprios botões com onclick
  document.querySelectorAll('.modal .close').forEach(closeBtn => {
      closeBtn.addEventListener('click', () => {
          // Encontra o modal pai do botão clicado
          let modal = closeBtn.closest('.modal');
          if (modal) {
              fecharModal(modal.id);
          }
      });
  });

  // Listener para fechar modal clicando fora do conteúdo
  window.addEventListener('click', (event) => {
      if (event.target.classList.contains('modal')) {
          fecharModal(event.target.id);
      }
  });

  // Inicializa o select de mês/ano do modal (chamado ao abrir o modal)
  // populateScheduleModal(); 

});

// Funções auxiliares (showSuccess, showError, getMonthNamesArray) já estão no script novo



// ----- INÍCIO DO CÓDIGO JAVASCRIPT PARA OS NOVOS MODAIS -----

// Variáveis globais para armazenar seleções temporárias
let pessoaSelecionada = null;
let mesSelecionado = null;
let anoSelecionado = null;

// Função para fechar qualquer modal pelo ID
function fecharModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
  }
}

// Função para abrir o Modal 1 (Seleção de Pessoa/Período)
function abrirModalSelecao() {
  // Pré-popula os selects de mês e ano se ainda não estiverem populados
  const scheduleMonthSelect = document.getElementById('schedule-month');
  const scheduleYearSelect = document.getElementById('schedule-year');

  // Chama a função para popular os selects ANTES de abrir o modal
  populateScheduleModal(); 

  // Limpa seleções anteriores
  document.querySelectorAll('input[name="pessoa"]').forEach(radio => radio.checked = false);
  scheduleMonthSelect.value = ''; // Reseta para "Selecione o mês"
  scheduleYearSelect.value = ''; // Reseta para "Selecione o ano"

  // Abre o modal
  const modal = document.getElementById('modalSelecaoPessoaMesAno');
  if (modal) {
    modal.style.display = 'block';
  }
}

// Função chamada pelo botão "Avançar" do Modal 1
function avancarParaCalendario() {
  // Valida a seleção
  const pessoaRadio = document.querySelector('input[name="pessoa"]:checked');
  const mesSelect = document.getElementById('schedule-month');
  const anoSelect = document.getElementById('schedule-year');

  if (!pessoaRadio) {
    alert('Por favor, selecione a pessoa.');
    return;
  }
  if (!mesSelect.value) {
    alert('Por favor, selecione o mês.');
    return;
  }
  if (!anoSelect.value) {
    alert('Por favor, selecione o ano.');
    return;
  }

  // Armazena as seleções
  pessoaSelecionada = pessoaRadio.value;
  mesSelecionado = getMonthNumber(mesSelect.value); // Converte nome do mês para número (0-11)
  anoSelecionado = parseInt(anoSelect.value);

  // Fecha o Modal 1
  fecharModal('modalSelecaoPessoaMesAno');

  // Abre o Modal 2 (Calendário)
  abrirModalCalendario();
}

// Função para abrir o Modal 2 (Calendário com Checkboxes)
function abrirModalCalendario() {
  const modal = document.getElementById('modalCalendarioDias');
  const tituloModal = document.getElementById('modalCalendarioTitulo');
  const containerCalendario = document.getElementById('calendario-checkbox-container');

  if (!modal || !tituloModal || !containerCalendario) {
    console.error('Elementos do Modal 2 não encontrados!');
    return;
  }

  // Atualiza o título do modal
  tituloModal.textContent = `Selecionar Dias de Folga - ${pessoaSelecionada} (${getMonthName(mesSelecionado)}/${anoSelecionado})`;

  // Gera o calendário com checkboxes
  gerarCalendarioCheckboxes(anoSelecionado, mesSelecionado, containerCalendario);

  // Adiciona listener ao link "Prefere adicionar tabela HTML?"
  const linkTabela = document.getElementById('linkTabelaHtml');
  if (linkTabela) {
      // Remove listeners antigos para evitar duplicação
      linkTabela.replaceWith(linkTabela.cloneNode(true));
      document.getElementById('linkTabelaHtml').addEventListener('click', (event) => {
          event.preventDefault();
          fecharModal('modalCalendarioDias');
          abrirModalTabelaHtml();
      });
  }

  // Adiciona listener ao botão "Salvar Folgas" do Modal 2
  const salvarDiasBtn = document.getElementById('salvarDiasCheckboxBtn');
   if (salvarDiasBtn) {
      // Remove listeners antigos para evitar duplicação
      salvarDiasBtn.replaceWith(salvarDiasBtn.cloneNode(true));
      document.getElementById('salvarDiasCheckboxBtn').addEventListener('click', salvarDiasCheckbox);
  }

  // Exibe o modal
  modal.style.display = 'block';
}

// Função para gerar o calendário com checkboxes no Modal 2
function gerarCalendarioCheckboxes(year, month, container) {
  container.innerHTML = ''; // Limpa o conteúdo anterior

  const firstDayOfMonth = new Date(year, month, 1);
  const lastDayOfMonth = new Date(year, month + 1, 0);
  const daysInMonth = lastDayOfMonth.getDate();
  const startDayOfWeek = firstDayOfMonth.getDay(); // 0 = Domingo, 6 = Sábado

  const monthKey = `${getMonthName(month)} ${year}`;
  // Busca os dias de folga atuais para a pessoa e mês/ano selecionados
  const diasDeFolgaAtuais = (schedules[pessoaSelecionada] && schedules[pessoaSelecionada][monthKey]) ? schedules[pessoaSelecionada][monthKey] : [];

  const table = document.createElement('table');
  table.style.width = '100%'; // Ajusta a largura da tabela
  const thead = table.createTHead();
  const tbody = table.createTBody();

  // Cabeçalho com dias da semana
  const headerRow = thead.insertRow();
  const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
  weekDays.forEach(day => {
    const th = document.createElement('th');
    th.textContent = day;
    headerRow.appendChild(th);
  });

  let date = 1;
  for (let i = 0; i < 6; i++) { // Cria até 6 linhas (semanas)
    const row = tbody.insertRow();
    for (let j = 0; j < 7; j++) { // 7 dias por semana
      const cell = row.insertCell();
      if (i === 0 && j < startDayOfWeek) {
        // Células vazias antes do primeiro dia do mês
        cell.classList.add('empty');
      } else if (date > daysInMonth) {
        // Células vazias após o último dia do mês
        cell.classList.add('empty');
      } else {
        // Célula do dia válido
        cell.style.verticalAlign = 'middle'; // Centraliza verticalmente
        cell.style.textAlign = 'center'; // Centraliza horizontalmente
        cell.style.padding = '5px';

        const checkboxId = `day-${date}`;
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = date;
        // Marca o checkbox se o dia estiver na lista de folgas atuais
        checkbox.checked = diasDeFolgaAtuais.includes(date);
        checkbox.style.marginRight = '5px';

        const label = document.createElement('label');
        label.htmlFor = checkboxId;
        label.textContent = date;
        label.style.display = 'inline-block'; // Para ficar ao lado do checkbox
        label.style.cursor = 'pointer'; // Melhora usabilidade

        // Adiciona um container para melhor controle (opcional)
        const dayContainer = document.createElement('div');
        dayContainer.appendChild(checkbox);
        dayContainer.appendChild(label);
        cell.appendChild(dayContainer);

        date++;
      }
    }
    if (date > daysInMonth) {
        break; // Para de criar linhas se todos os dias foram adicionados
    }
  }

  container.appendChild(table);
}

// Função para salvar as folgas selecionadas no Modal 2 (Checkboxes)
function salvarDiasCheckbox() {
  const checkboxes = document.querySelectorAll('#calendario-checkbox-container input[type="checkbox"]:checked');
  const diasSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.value));

  console.log(`Salvando folgas para ${pessoaSelecionada} em ${getMonthName(mesSelecionado)}/${anoSelecionado}:`, diasSelecionados);

  // Atualiza o objeto 'schedules'
  const monthKey = `${getMonthName(mesSelecionado)} ${anoSelecionado}`;
  if (!schedules[pessoaSelecionada]) {
    schedules[pessoaSelecionada] = {};
  }
  schedules[pessoaSelecionada][monthKey] = diasSelecionados.sort((a, b) => a - b); // Salva ordenado

  // Fecha o modal
  fecharModal('modalCalendarioDias');

  // Salva no Gist e atualiza o calendário principal
  saveSchedulesToGist()
    .then(() => {
      console.log('Folgas salvas com sucesso via checkboxes.');
      // Atualiza o calendário principal para refletir as mudanças
      loadMonth(monthKey);
      updateMonthSelect(); // Atualiza o select de meses caso um novo mês tenha sido adicionado
      showSuccess('Folgas salvas com sucesso!'); // Usa a função showSuccess existente
    })
    .catch(error => {
      console.error('Erro ao salvar folgas via checkboxes:', error);
      showError('Erro ao salvar as folgas. Verifique o console para detalhes.'); // Usa a função showError existente
    });
}

// Função para abrir o Modal 3 (Input Tabela HTML)
function abrirModalTabelaHtml() {
  const modal = document.getElementById('modalTabelaHtml');
  const textarea = document.getElementById('tabelaHtmlInput');

  if (!modal || !textarea) {
    console.error('Elementos do Modal 3 não encontrados!');
    return;
  }

  // Limpa o textarea
  textarea.value = '';

  // Adiciona listener ao botão "Salvar Folgas" do Modal 3
  const salvarTabelaBtn = document.getElementById('salvarTabelaHtmlBtn');
   if (salvarTabelaBtn) {
      // Remove listeners antigos para evitar duplicação
      salvarTabelaBtn.replaceWith(salvarTabelaBtn.cloneNode(true));
      document.getElementById('salvarTabelaHtmlBtn').addEventListener('click', salvarTabelaHtml);
  }

  // Exibe o modal
  modal.style.display = 'block';
}

// Função para salvar as folgas do Modal 3 (Tabela HTML/Texto)
function salvarTabelaHtml() {
  const inputData = document.getElementById('tabelaHtmlInput').value;
  if (!inputData.trim()) {
    alert('Por favor, cole a tabela HTML ou a sequência de dias.');
    return;
  }

  let diasDeFolga = [];
  try {
    // Usa a função existente para extrair os dias
    diasDeFolga = extractDaysOffFromInput(inputData);
    if (!Array.isArray(diasDeFolga)) { // Validação básica do retorno
        throw new Error('A extração não retornou uma lista de dias.');
    }
  } catch (error) {
    console.error('Erro ao processar a entrada:', error);
    alert('Erro ao processar a entrada. Verifique o formato da tabela ou da sequência de dias.\nDetalhes: ' + error.message);
    return;
  }

  console.log(`Salvando folgas para ${pessoaSelecionada} em ${getMonthName(mesSelecionado)}/${anoSelecionado} via Tabela/Texto:`, diasDeFolga);

  // Atualiza o objeto 'schedules'
  const monthKey = `${getMonthName(mesSelecionado)} ${anoSelecionado}`;
  if (!schedules[pessoaSelecionada]) {
    schedules[pessoaSelecionada] = {};
  }
  schedules[pessoaSelecionada][monthKey] = diasDeFolga.sort((a, b) => a - b); // Salva ordenado

  // Fecha o modal
  fecharModal('modalTabelaHtml');

  // Salva no Gist e atualiza o calendário principal
  saveSchedulesToGist()
    .then(() => {
      console.log('Folgas salvas com sucesso via Tabela/Texto.');
      // Atualiza o calendário principal para refletir as mudanças
      loadMonth(monthKey);
      updateMonthSelect(); // Atualiza o select de meses
      showSuccess('Folgas salvas com sucesso!'); // Usa a função showSuccess existente
    })
    .catch(error => {
      console.error('Erro ao salvar folgas via Tabela/Texto:', error);
      showError('Erro ao salvar as folgas. Verifique o console para detalhes.'); // Usa a função showError existente
    });
}

// Função auxiliar para obter nomes dos meses (usada internamente)
function getMonthNamesArray() {
    return ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
}

// ----- FIM DO CÓDIGO JAVASCRIPT PARA OS NOVOS MODAIS -----

</script>

</body>
</html>

