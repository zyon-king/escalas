<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Escala de Folgas - M√™s Completo</title>
		<style>
			body {
			font-family: Arial, sans-serif;
			margin: 20px;
			}
			h1 {
			text-align: center;
			margin-bottom: 20px;
			}
            
        	/*clamp(valor m√≠nimo, valor ideal, valor m√°ximo)*/
			/**/
			.computer-mode {
			width: 1000px;
			margin: 0 auto;
			font-size: 16px;
			}
			.switch {
			position: relative;
			display: inline-block;
			width: 45px;
			height: 25px;
			}
			.switch input {
			opacity: 0;
			width: 0;
			height: 0;
			}
			.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: 0.4s;
			}
			.slider:before {
			position: absolute;
			content: "";
			height: 19px; /* Ajuste o height da bolinha para ser um pouco menor que o switch */
			width: 19px; /* Ajuste o width da bolinha para ser igual ao height */
			left: 3px; /* Ajuste a posi√ß√£o esquerda da bolinha */
			bottom: 3px; /* Ajuste a posi√ß√£o inferior da bolinha */
			background-color: white;
			transition: 0.4s;
			}
			input:not(:checked) + .slider {
			background-color: #1abc9c; /* Cor do switch desligado */
			}
			input:checked + .slider {
			background-color: #2196F3;
			}
			input:focus + .slider {
			box-shadow: 0 0 1px #2196F3;
			}
			input:checked + .slider:before {
			transform: translateX(20px);
			}
			.slider.round {
			border-radius: 20px;
			}
			.slider.round:before {
			border-radius: 50%;
			}
			.mode-container {
			display: flex;
			align-items: center;
			}
			.mode-status {
			margin-left: 10px;
			font-size: 16px;
			}
			/**/
			.token {
			text-align: center;
			margin-bottom: 20px;
			}
			.token button {
			padding: 15px 30px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 600;
			font-size: 20px;
			min-width: 120px;
			}	  
			.token button:hover {
			background-color: #0056b3;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
			}
			.token input {
			text-align: center;
			width: 700px;
			max-width: 90%;
			height: 50px;
			margin-bottom: 15px; /* Adiciona um espa√ßo entre o input e o bot√£o */
			}
            
      /**/  
      .notification {
			    position: fixed;
			    top: 15px; /* Valor fixo para garantir que fique no topo */
			    right: 15px; /* Valor fixo para garantir que fique na direita */
			    cursor: pointer;
			    z-index: 9999; /* Garante que fique acima de outros elementos */
			    width: clamp(45px, 10vw, 70px);
			    height: clamp(45px, 10vw, 70px); /* Mant√©m quadrado */
			    display: flex;
			    align-items: center;
			    justify-content: center;
			    /* position: relative; foi removido pois 'position: fixed' j√° estabelece o contexto de posicionamento para filhos com 'position: absolute' */
			}
			.notification img {
			    width: 100%;
			    height: auto;
			    aspect-ratio: 1 / 1;
			    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
			}
			.notification .counter {
			    position: absolute;
			    /* Ajuste de posi√ß√£o RELATIVA √† .notification */
			    top: -5%;
			    right: -5%; /* O counter continua no canto superior direito do √≠cone */
			    background-color: 
			    color: #fff;
			    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
			    border-radius: 50%;
                
          display: flex;
			    padding: 5%; /* relativo ao width do pai */
			    width: 40%;
			    height: 40%;
			}		
      
      .notification .counter img {
          width: 100%;
          height: 100%;
          filter: none;
      }
			/**/   
			.controls {
			text-align: center;
			margin-bottom: 20px;
			}
			.controls select {
			padding: 12px 16px;
			margin-right: 10px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			background-color: white;
			font-size: 16px;
			font-weight: 500;
			transition: all 0.3s ease;
			min-width: 180px;
			margin-bottom: 15px; /* Adiciona um espa√ßo entre o input e o bot√£o */
			}
			.controls select:focus {
			border-color: #007bff;
			outline: none;
			box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
			}
			.controls button {
			padding: 12px 25px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 600;
			font-size: 20px;
			min-width: 140px;
			}
			.controls button:hover {
			background-color: #0056b3;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
			}
			/* Modal styles */
			.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.5);
			}
			.modal-content {
			background-color: white;
			margin: 1% auto;
			padding: 20px;
			border-radius: 8px;
			width: 90%;
			max-width: 750px; /* Remova o limite de largura m√°ximo */
			max-height: 95vh;
			overflow-y: auto;
			}
			.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			border-bottom: 1px solid #eee;
			padding-bottom: 10px;
			}
			.close {
			color: #aaa;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			}
			.close:hover {
			color: #000;
			}
			.form-group {
			margin-bottom: 15px;
			}
			.form-group label {
			display: block;
			margin-bottom: 5px;
			}
			.person-selection label, .date-selection label {
			font-weight: bold;
			font-size: 18px; /* Aumente o tamanho da fonte */
			}
			#scheduleModal label {
			font-size: 30px; /* Aumente o tamanho da fonte */
			}
			.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px; /* Aumente o espa√ßamento interno */
			border: 1px solid #ccc;
			border-radius: 4px;
			box-sizing: border-box;
			font-size: 20px; /* Aumente o tamanho da fonte */
			}
			.form-group textarea {
			height: 150px;
			resize: vertical;
			}
			.person-selection {
			display: flex;
			gap: 20px;
			margin-bottom: 15px;
			}
			.person-option {
			display: flex;
			align-items: center; /* Garante alinhamento vertical */
			gap: 8px;
			}
			.person-option input[type="radio"] {
			width: 20px; /* 25px pode ser grande demais para alinhar com texto */
			height: 20px;
			margin: 0;
			vertical-align: middle; /* importante */
			}
			.date-selection {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			}
			.date-selection select {
			flex: 1;
			}
			.modal-buttons button {
			padding: 15px 30px;
			margin-right: 30px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 20px;
			transition: all 0.3s ease;
			font-weight: 600;
			min-width: 120px;
			margin-bottom: 15px; /* Adiciona um espa√ßo entre o input e o bot√£o */
			}
			.modal-step {
			min-height: 200px;
			}
			.modal-step.hidden {
			display: none !important;
			}
			.btn-primary {
			background-color: #007bff;
			color: white;
			}
			.btn-primary:hover {
			background-color: #0056b3;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
			}
			.btn-secondary {
			background-color: #6c757d;
			color: white;
			}
			.btn-secondary:hover {
			background-color: #5a6268;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
			}
			.editable-calendar {
			margin: 20px 0;
			}
			.editable-calendar table {
			width: 100%;
			max-width: 500px;
			margin: 0 auto;
			}
			.day-checkbox {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 5px;
			}
			.day-checkbox input[type="checkbox"] {
			width: 18px;
			height: 18px;
			margin: 0;
			}
			.day-checkbox label {
			font-size: 14px;
			cursor: pointer;
			margin: 0;
			}
			.editable-calendar td {
			padding: 10px 5px;
			text-align: center;
			}
			.editable-calendar .empty {
			background-color: #f5f5f5;
			}
			.toggle-input-link {
			text-align: right;
			margin: 15px 0;
			}
			.toggle-input-link a {
			color: #007bff;
			text-decoration: none;
			font-size: 16px;
			}
			.toggle-input-link a:hover {
			text-decoration: underline;
			color: #0056b3;
			}
			table {
			padding: 8px 4px;
			width: 850px;
			margin: auto;
			border-collapse: collapse;
			table-layout: fixed;
			}
			th, td {
			border: 1px solid #ccc;
			text-align: center;
			padding: 8px 4px;
			vertical-align: top;
			word-wrap: break-word;
			}
			th {
			background-color: #007bff;
			color: white;
			}
			.weekend {
			background-color: #d4edda; /* verde claro */
			color: #155724; /* texto verde escuro */
			}
			.workday {
			background-color: #d4edda;
			color: #155724;
			}
			.cris-day-off {
			background-color: #FFC0CB; /* rosa claro */
			}
			.clei-day-off {
			background-color: #b8daff; /* azul claro */
			}
			.person-name {
			font-weight: bold;
			}
			.loading {
			text-align: center;
			padding: 20px;
			color: #666;
			}
			.alert {
			position: relative;
			z-index: 10000;
			text-align: center;
			padding: 20px;
			border-radius: 4px;
			margin: 20px 0;
			}
			.error {
			background-color: #f8d7da;
			color: #d63384;
			border: 1px solid #f5c2c7;
			}
			.success {
			background-color: #ADD8E6;
			color: #000;
			}
			/* Estilos para popups customizados */
			#customPopup {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			}
			.popup-content {
			background-color: white;
			margin: 50px auto 0 auto;
			padding: 20px;
			border-radius: 8px;
			width: 90%;
			max-width: 400px;
			text-align: center;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
			position: relative;
			top: 20px;
			}
			@keyframes popupSlideIn {
			from {
			opacity: 0;
			transform: translate(-50%, -60%);
			}
			to {
			opacity: 1;
			transform: translate(-50%, -50%);
			}
			}
			.popup-content.success {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			}
			.popup-content.error {
			background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
			}
			.popup-content.confirm {
			background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
			}
			.popup-icon {
			font-size: 48px;
			margin-bottom: 15px;
			display: block;
			}
			.popup-title {
			font-size: 22px;
			font-weight: bold;
			margin-bottom: 15px;
			color: white;
			}
			.popup-content.confirm .popup-title {
			color: #333;
			}
			.popup-message {
			font-size: 30px;
			line-height: 1.5;
			margin-bottom: 25px;
			color: white;
			}
			.popup-content.confirm .popup-message {
			color: #555;
			}
			.popup-buttons {
			display: flex;
			justify-content: center;
			gap: 15px;
			}
			.popup-btn {
			padding: 12px 25px;
			border: none;
			border-radius: 8px;
			font-size: 16px;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 600;
			min-width: 100px;
			}
			.popup-btn-primary {
			background-color: #007bff;
			color: white;
			}
			.popup-btn-primary:hover {
			background-color: #0056b3;
			transform: translateY(-2px);
			}
			.popup-btn-secondary {
			background-color: #6c757d;
			color: white;
			}
			.popup-btn-secondary:hover {
			background-color: #5a6268;
			transform: translateY(-2px);
			}
			.popup-btn-success {
			background-color: #28a745;
			color: white;
			}
			.popup-btn-success:hover {
			background-color: #218838;
			transform: translateY(-2px);
			}
			@media only screen and (max-width: 768px) {
			#calendar-body td {
			font-size: 12px; /* Defina o tamanho da fonte desejado */
			}
			table {
			width: 100%;
			font-size: 16px; /* Ajuste o tamanho da fonte para melhor legibilidade */
			}
			table thead th {
			font-size: 11px; /* Defina o tamanho da fonte  */
			padding: 5px; /* Ajuste o espa√ßamento entre c√©lulas */
			}
			th, td {
			padding: 10px; /* Ajuste o espa√ßamento entre c√©lulas */
			}
			.controls {
			width: 100%; /* Ocupa toda a largura da tela */
			padding: 10px; /* Ajuste o espa√ßamento */
			}
			.token {
			width: 100%; /* Ocupa toda a largura da tela */
			padding: 10px; /* Ajuste o espa√ßamento */
			}			
		</style>
	</head>
	<body>
		<div class="mode-container">
			<label class="switch">
			<input type="checkbox" id="mode-toggle">
			<span class="slider round"></span>
			</label>
			<span class="mode-status" id="mode-status">Mode</span>
		</div>
		<h1>Escala de Folgas</h1>        
    	
    <div class="notification">
        <img src="https://cdn.jsdelivr.net/gh/zyon-king/escalas@main/notification-new.svg" alt="Sino Gradient Icon" />
        <span class="counter">
            <img src="https://cdn.jsdelivr.net/gh/zyon-king/escalas@main/counter-new.svg" alt="Counter Icon" />
        </span>
    </div>
        
		<div class="controls">
			<select id="month-select">
				<option value="">Carregando...</option>
			</select>
			<button id="add-schedule-btn">Editar Folgas</button>
		</div>
        
		<div id="loading" class="loading" style="display: none;">Carregando dados...</div>
		<div id="error" class="error" style="display: none;"></div>
        
		<table>
			<thead>
				<tr>
					<th>Dom</th>
					<th>Seg</th>
					<th>Ter</th>
					<th>Qua</th>
					<th>Qui</th>
					<th>Sex</th>
					<th>S√°b</th>
				</tr>
			</thead>
			<tbody id="calendar-body">
			</tbody>
		</table>
		<!-- Modal para adicionar escala -->
		<div id="scheduleModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>Editar Folgas</h2>
					<span class="close">&times;</span>
				</div>
				<!-- Primeira etapa: Sele√ß√£o de dados -->
				<div id="step1" class="modal-step">
					<div class="form-group">
						<label>Selecione a pessoa:</label>
						<div class="person-selection">
							<div class="person-option">
								<input type="radio" id="cris" name="pessoa" value="Cris">
								<label for="cris">Cris</label>
							</div>
							<div class="person-option">
								<input type="radio" id="clei" name="pessoa" value="Clei">
								<label for="clei">Clei</label>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label>Per√≠odo da escala:</label>
						<div class="date-selection">
							<select id="schedule-month">
								<option value="">Selecione o m√™s</option>
							</select>
							<select id="schedule-year">
								<option value="">Selecione o ano</option>
							</select>
						</div>
						<div class="toggle-input-link">
						  <a href="#" id="delete-schedule-link" style="color: #dc3545;">Excluir escala</a>
						</div>
					</div>
					<div class="modal-buttons">
						<button class="btn-secondary" id="cancel-btn">Cancelar</button>
						<button class="btn-primary" id="next-btn">Avan√ßar</button>
					</div>
				</div>
				<!-- Segunda etapa: Input das folgas -->
				<div id="step2" class="modal-step" style="display: none;">
					<!-- Se√ß√£o do calend√°rio (vis√≠vel por padr√£o) -->
					<div id="calendar-section">
						<div class="form-group">
							<label>Marque os dias de folga no calend√°rio:</label>
							<div class="editable-calendar">
								<table>
									<thead>
										<tr>
											<th>Dom</th>
											<th>Seg</th>
											<th>Ter</th>
											<th>Qua</th>
											<th>Qui</th>
											<th>Sex</th>
											<th>S√°b</th>
										</tr>
									</thead>
									<tbody id="editable-calendar-body">
									</tbody>
								</table>
							</div>
						</div>
						<div class="toggle-input-link">
							<a href="#" id="show-table-input">Prefere colar tabela HTML?</a>
						</div>
					</div>
					<!-- Se√ß√£o do textarea (oculta por padr√£o) -->
					<div id="table-input-section" style="display: none;">
						<div class="form-group">
							<label for="schedule-table">Cole a tabela HTML da escala ou sequ√™ncia separada por ",":</label>
							<textarea id="schedule-table" placeholder="<table><tbody><tr><td... ou 14, 15,"></textarea>
						</div>
						<div class="toggle-input-link">
							<a href="#" id="show-calendar">Prefere usar o calend√°rio?</a>
						</div>
					</div>
					<div class="modal-buttons">
						<button class="btn-secondary" id="back-btn">Voltar</button>
						<button class="btn-primary" id="save-schedule-btn">Salvar Escala</button>
					</div>
				</div>
			</div>
		</div>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@18.2.0"></script>
<script>
// íÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇ
// Bloco AppWrite | Inicio
// íÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇ
let databases, Query, ID, client;

function initAppwrite() {
  return new Promise((resolve, reject) => {
    // Se j√° inicializou, resolve imediatamente
    if (client) {
      resolve();
      return;
    }
    
    // Verifica se Appwrite est√° dispon√≠vel
    if (typeof Appwrite !== 'undefined') {
      try {
        client = new Appwrite.Client()
          .setEndpoint('https://nyc.cloud.appwrite.io/v1')
          .setProject('686a67d5003a1b4b1bf9');
        
        databases = new Appwrite.Databases(client);
        Query = Appwrite.Query;
        ID = Appwrite.ID;
        resolve();
      } catch (error) {
        reject(error);
      }
    } else {
      // Se Appwrite n√£o est√° carregado, aguarda um pouco e tenta novamente
      setTimeout(() => {
        initAppwrite().then(resolve).catch(reject);
      }, 500);
    }
  });
}

async function saveScheduleAppwrite(pessoa, ano, mes, folgas) {
  try {
    // Garante que a inicializa√ß√£o ocorreu antes de usar as vari√°veis.
    await initAppwrite();

    const DATABASE_ID = '686a68130002b51fced0';
    const COLLECTION_ID = '68c535f2001de9505bde';
    
    // Converte o n√∫mero do m√™s para nome do m√™s
    const meses = [
      'janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho',
      'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
    ];
    const nomeDoMes = meses[parseInt(mes) - 1];
    
    const response = await databases.listDocuments(DATABASE_ID, COLLECTION_ID, [
      Query.equal('people', pessoa),
      Query.equal('year', parseInt(ano)),
      Query.equal('month', nomeDoMes)
    ]);

    const dadosParaSalvar = {
      people: pessoa,
      year: parseInt(ano),
      month: nomeDoMes,
      daysOff: folgas.map(dia => parseInt(dia))
    };

    if (response.documents.length > 0) {
      const documentId = response.documents[0].$id;
      await databases.updateDocument(DATABASE_ID, COLLECTION_ID, documentId, dadosParaSalvar);
    } else {
      await databases.createDocument(DATABASE_ID, COLLECTION_ID, ID.unique(), dadosParaSalvar);
    }
  } catch (error) {
    console.error('Erro ao salvar no Appwrite:', error);
    alert('Erro ao salvar escala: ' + error.message);
    throw error;
  }
}

// ====================
// Gerar Lista de Meses
// ====================
async function loadAvailableMonthsYears() {
  try {
    await initAppwrite();

    const DATABASE_ID = '686a68130002b51fced0';
    const COLLECTION_ID = '68c535f2001de9505bde';

    const response = await databases.listDocuments(DATABASE_ID, COLLECTION_ID);

    const mesAnoSet = new Set();

    const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();

    response.documents.forEach(doc => {
      if (doc.month && doc.year) {
        const mesCapitalizado = capitalize(doc.month);
        mesAnoSet.add(`${mesCapitalizado}-${doc.year}`);
      }
    });

    const mesesLista = [
      'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    const mesAnoArray = Array.from(mesAnoSet).map(item => {
      const [mesNome, ano] = item.split('-');
      const mesIndex = mesesLista.findIndex(m => m === mesNome) + 1;
      return { mesNome, ano: parseInt(ano), mesIndex };
    });

    mesAnoArray.sort((a, b) => {
      if (a.ano === b.ano) return a.mesIndex - b.mesIndex;
      return a.ano - b.ano;
    });

    const monthSelect = document.getElementById('month-select');
    monthSelect.innerHTML = '';

    mesAnoArray.forEach(({ mesNome, ano, mesIndex }) => {
      const option = document.createElement('option');
      option.value = `${ano}-${mesIndex.toString().padStart(2, '0')}`;
      option.textContent = `${mesNome} / ${ano}`;
      monthSelect.appendChild(option);
    });

    if (mesAnoArray.length === 0) {
      const option = new Option('Nenhum m√™s carregado', '');
      monthSelect.appendChild(option);
    } else {
      // NOVO: Selecionar automaticamente o m√™s atual ou o mais pr√≥ximo
      const dataAtual = new Date();
      const mesAtual = dataAtual.getMonth() + 1;
      const anoAtual = dataAtual.getFullYear();
      
      // Procura o m√™s atual primeiro
      let opcaoParaSelecionar = mesAnoArray.find(item => 
        item.mesIndex === mesAtual && item.ano === anoAtual
      );
      
      // Se n√£o encontrar o m√™s atual, pega o primeiro dispon√≠vel
      if (!opcaoParaSelecionar) {
        opcaoParaSelecionar = mesAnoArray[0];
      }
      
      // Define o valor selecionado
      const valorParaSelecionar = `${opcaoParaSelecionar.ano}-${opcaoParaSelecionar.mesIndex.toString().padStart(2, '0')}`;
      monthSelect.value = valorParaSelecionar;
      
      // Constr√≥i o calend√°rio automaticamente
      buildCalendar(opcaoParaSelecionar.ano, opcaoParaSelecionar.mesIndex);
    }
  } catch (error) {
    console.error('Erro ao carregar meses e anos dispon√≠veis:', error);
    alert('Erro ao carregar meses e anos. Veja console para mais detalhes.', error);
  }
}

loadAvailableMonthsYears();

// ====================
// Construir Calendario
// ====================

// Ouvinte de evento ao select para disparar a atualiza√ß√£o do calend√°rio
document.getElementById('month-select').addEventListener('change', handleMonthSelectChange);

function handleMonthSelectChange() {
  const monthSelect = document.getElementById('month-select');
  const selectedValue = monthSelect.value; // Exemplo: "2025-09"
  if (!selectedValue) return; // Nada selecionado

  // Divide o valor "YYYY-MM" para ano e m√™s
  const [yearStr, monthStr] = selectedValue.split('-');
  const year = parseInt(yearStr);
  const month = parseInt(monthStr);

  // Chama fun√ß√£o buildCalendar existente para montar o calend√°rio
  buildCalendar(year, month);
}

// ====================
// Combinar Escalas
// ====================
async function buildCalendar(year, month) {
  const calendarBody = document.getElementById('calendar-body');
  if (!calendarBody) {
    console.error("Elemento 'calendar-body' n√£o encontrado!");
    return;
  }

  calendarBody.innerHTML = '';
  const firstDayOfMonth = new Date(year, month - 1, 1);
  const lastDayOfMonth = new Date(year, month, 0);
  const daysInMonth = lastDayOfMonth.getDate();
  const startDayOfWeek = firstDayOfMonth.getDay();
  
  // Definir os nomes dos meses diretamente
  const mesesNomes = [
    'janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho',
    'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
  ];
  
  // Capitalizar primeira letra do m√™s para manter consist√™ncia
  const mesCapitalizado = mesesNomes[month - 1].charAt(0).toUpperCase() + mesesNomes[month - 1].slice(1);
  const monthKey = `${mesCapitalizado} ${year}`;

  // Carregar dados das folgas do Appwrite e montar objeto schedules
  let schedules = {};
  let people = []; // Array din√¢mico baseado nos dados do banco
  
  try {
    await initAppwrite();
    const DATABASE_ID = '686a68130002b51fced0';
    const COLLECTION_ID = '68c535f2001de9505bde';
    
    const response = await databases.listDocuments(DATABASE_ID, COLLECTION_ID, [
      Query.equal('year', year),
      Query.equal('month', mesesNomes[month - 1])
    ]);
    
    console.log('Dados carregados do Appwrite:', response.documents);
    
    // Montar o objeto schedules e array people dinamicamente
    response.documents.forEach(doc => {
      if (!people.includes(doc.people)) {
        people.push(doc.people); // Adiciona a pessoa ao array se n√£o existir
      }
      
      if (!schedules[doc.people]) {
        schedules[doc.people] = {};
      }
      schedules[doc.people][monthKey] = doc.daysOff || [];
      console.log(`Folgas para ${doc.people} em ${monthKey}:`, doc.daysOff);
    });
    
    console.log('Pessoas encontradas:', people);
    console.log('Objeto schedules montado:', schedules);
    console.log('monthKey usado:', monthKey);
    
  } catch (error) {
    console.error('Erro ao carregar dados das folgas:', error);
  }

  let date = 1;

  for (let week = 0; week < 6; week++) {
    const row = document.createElement('tr');

    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
      const cell = document.createElement('td');

      if (week === 0 && dayOfWeek < startDayOfWeek) {
        cell.classList.add('empty');
      } else if (date > daysInMonth) {
        cell.classList.add('empty');
      } else {
        let cellContent = `<div class="day-title">${date}</div>`;
        
        people.forEach(person => {
          let status = '';
          let className = 'workday';

          if (schedules[person] && schedules[person][monthKey]) {
            const dayOffList = schedules[person][monthKey];
            
            // Garantir que tanto date quanto os valores da lista sejam do mesmo tipo
            if (dayOffList.includes(parseInt(date)) || dayOffList.includes(date.toString())) {
              status = '';
              className = person.toLowerCase().replace(' ', '-') + '-day-off';
              cellContent += `<div class="${className}"><span class="person-name">${person}</span> ${status}</div>`;
              console.log(`Folga encontrada: ${person} no dia ${date}`);
            }
          }
        });

        cell.innerHTML = cellContent;
        date++;
      }

      row.appendChild(cell);
    }

    calendarBody.appendChild(row);

    if (date > daysInMonth) {
      break;
    }
  }
}

// ====================
// Excluir Escalas
// ====================
async function deleteScheduleAppwrite(pessoa, ano, mes) {
  try {
    await initAppwrite();

    const DATABASE_ID = '686a68130002b51fced0';
    const COLLECTION_ID = '68c535f2001de9505bde';
    
    // Converte o n√∫mero do m√™s para nome do m√™s
    const meses = [
      'janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho',
      'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
    ];
    const nomeDoMes = meses[parseInt(mes) - 1];
    
    const response = await databases.listDocuments(DATABASE_ID, COLLECTION_ID, [
      Query.equal('people', pessoa),
      Query.equal('year', parseInt(ano)),
      Query.equal('month', nomeDoMes)
    ]);

    if (response.documents.length > 0) {
      const documentId = response.documents[0].$id;
      await databases.deleteDocument(DATABASE_ID, COLLECTION_ID, documentId);
      console.log('Escala exclu√≠da com sucesso!');
    } else {
      throw new Error('Escala n√£o encontrada para exclus√£o.');
    }
  } catch (error) {
    console.error('Erro ao excluir no Appwrite:', error);
    throw error;
  }
}
// íÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇ
// Bloco AppWrite | Fim
// íÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇíÖÇ

const FolgasEditor = (() => {
  // Estado interno da edi√ß√£o
  let state = {
    isModalOpen: false,
    pessoaSelecionada: null,
    mesSelecionado: null,
    anoSelecionado: null,
    folgasSelecionadas: new Set(),
  };
//

  // Cache de elementos DOM
  const elements = {
    modal: document.getElementById('scheduleModal'),
    closeBtn: document.querySelector('#scheduleModal .close'),
    nextBtn: document.getElementById('next-btn'),
    cancelBtn: document.getElementById('cancel-btn'),
    backBtn: document.getElementById('back-btn'),
    saveBtn: document.getElementById('save-schedule-btn'),
    pessoaRadios: document.querySelectorAll('input[name="pessoa"]'),
    monthSelect: document.getElementById('schedule-month'),
    yearSelect: document.getElementById('schedule-year'),
    editableCalendarBody: document.getElementById('editable-calendar-body'),
    step1: document.getElementById('step1'),
    step2: document.getElementById('step2'),
    deleteLink: document.getElementById('delete-schedule-link'),
    // Outras refer√™ncias conforme necess√°rio
  };

  // Fun√ß√£o para abrir modal com inicializa√ß√£o
  function openModal() {
    loadSelectOptions();
    clearState();

    // NOVO: Capturar m√™s e ano atualmente visualizados
    const monthSelect = document.getElementById('month-select');
    if (monthSelect.value) {
      const [yearStr, monthStr] = monthSelect.value.split('-');
      const year = parseInt(yearStr);
      const month = parseInt(monthStr);

      // Pr√©-selecionar no modal
      elements.monthSelect.value = month;
      elements.yearSelect.value = year;

      // Atualizar o estado interno
      state.mesSelecionado = month.toString();
      state.anoSelecionado = year.toString();
    }

    renderStep1();
    elements.modal.style.display = 'block';
    state.isModalOpen = true;
    attachListeners();
    updateDeleteLinkText();
  }

  // Fun√ß√£o para fechar modal e limpar listeners
  function closeModal() {
    elements.modal.style.display = 'none';
    state.isModalOpen = false;
    detachListeners();
  }

  // Limpa o estado antes de nova edi√ß√£o
  function clearState() {
    state.pessoaSelecionada = null;
    state.mesSelecionado = null;
    state.anoSelecionado = null;
    state.folgasSelecionadas.clear();
    // Reset apenas os radio buttons, n√£o os selects (ser√£o definidos no openModal)
    elements.pessoaRadios.forEach(radio => radio.checked = false);
    // N√ÉO limpar os selects aqui - ser√° feito no openModal()
    // elements.monthSelect.value = '';
    // elements.yearSelect.value = '';
  }

  // Inicializa op√ß√µes dos selects m√™s e ano (exemplo)
  function loadSelectOptions() {
    // Aqui pode-se carregar meses e anos dinamicamente conforme necessidade
    // Exemplo simples:
    if (elements.monthSelect.options.length <= 1) {
      const meses = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      meses.forEach((mes, i) => {
        const option = new Option(mes, i + 1);
        elements.monthSelect.add(option);
      });
    }
    if (elements.yearSelect.options.length <= 1) {
      const anoAtual = new Date().getFullYear();
      for (let ano = anoAtual - 5; ano <= anoAtual + 5; ano++) {
        const option = new Option(ano, ano);
        elements.yearSelect.add(option);
      }
    }
  }

  // Fun√ß√£o para atualizar o texto do link de exclus√£o
  function updateDeleteLinkText() {
    const deleteLink = document.getElementById('delete-schedule-link');
    const selectedMonth = document.getElementById('schedule-month').value;
    const selectedYear = document.getElementById('schedule-year').value;

    if (deleteLink && selectedMonth && selectedYear) {
      // Converter n√∫mero do m√™s para nome
      const meses = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      const nomeDoMes = meses[parseInt(selectedMonth) - 1];
      deleteLink.textContent = `Excluir escala de ${nomeDoMes} de ${selectedYear}?`;
    } else {
      if (deleteLink) {
        deleteLink.textContent = 'Excluir escala';
      }
    }
  }
  
  // Fun√ß√£o para tratar a exclus√£o da escala
  async function handleDeleteSchedule(event) {
    event.preventDefault();

    // CORRIGIDO: Capturar os valores diretamente dos elementos DOM
    const pessoaSelecionada = Array.from(elements.pessoaRadios).find(r => r.checked)?.value || null;
    const mesSelecionado = elements.monthSelect.value || null;
    const anoSelecionado = elements.yearSelect.value || null;

    if (!pessoaSelecionada || !mesSelecionado || !anoSelecionado) {
      alert('Por favor, selecione pessoa, m√™s e ano primeiro.');
      return;
    }

    const meses = [
      'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    const nomeDoMes = meses[parseInt(mesSelecionado) - 1];

    const confirmacao = confirm("Tem certeza que deseja excluir a escala de " + pessoaSelecionada + " para " + nomeDoMes + " de " + anoSelecionado + "?");

    if (confirmacao) {
      try {
        await deleteScheduleAppwrite(pessoaSelecionada, anoSelecionado, mesSelecionado);
        alert('Escala exclu√≠da com sucesso!');
        closeModal();

        // Recarregar a lista de meses dispon√≠veis
        await loadAvailableMonthsYears();

      } catch (error) {
        console.error('Erro ao excluir escala:', error);
		alert("Erro ao excluir escala: " + error.message);      }
    }
  }

  // Renderiza primeira etapa (sele√ß√£o)
  function renderStep1() {
    elements.step1.style.display = 'block';
    elements.step2.style.display = 'none';
  }

  // Renderiza segunda etapa (calend√°rio ou textarea)
  function renderStep2() {
    elements.step1.style.display = 'none';
    elements.step2.style.display = 'block';
    renderEditableCalendar();
  }

  // Exemplo simples para montar calend√°rio edit√°vel
  async function renderEditableCalendar() {
    const mes = Number(elements.monthSelect.value);
    const ano = Number(elements.yearSelect.value);

    if (!mes || !ano) {
      console.error('M√™s ou ano n√£o selecionado');
      return;
    }

    try {
      // Limpa calend√°rio atual
      elements.editableCalendarBody.innerHTML = '';

      // Limpa sele√ß√µes anteriores
      state.folgasSelecionadas.clear();

      // NOVO: Carregar dados existentes do Appwrite
      let folgasExistentes = [];
      if (state.pessoaSelecionada) {
        try {
          await initAppwrite();
          const DATABASE_ID = '686a68130002b51fced0';
          const COLLECTION_ID = '68c535f2001de9505bde';

          const mesesNomes = [
            'janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho',
            'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
          ];

          const response = await databases.listDocuments(DATABASE_ID, COLLECTION_ID, [
            Query.equal('people', state.pessoaSelecionada),
            Query.equal('year', parseInt(ano)),
            Query.equal('month', mesesNomes[mes - 1])
          ]);

          if (response.documents.length > 0) {
            folgasExistentes = response.documents[0].daysOff || [];
            console.log('Folgas existentes carregadas:', folgasExistentes);
          }
        } catch (error) {
          console.error('Erro ao carregar folgas existentes:', error);
        }
      }

      // Obter n√∫mero de dias no m√™s
      const diasNoMes = new Date(ano, mes, 0).getDate();
      const primeiroDia = new Date(ano, mes - 1, 1);
      const diaDaSemanaInicial = primeiroDia.getDay();

      // Gerar linhas e c√©lulas para cada dia
      let diaAtual = 1;
      let semanaAtual = 0;

      // Criar semanas at√© cobrir todos os dias
      while (diaAtual <= diasNoMes) {
        const row = document.createElement('tr');

        for (let diaDaSemana = 0; diaDaSemana < 7; diaDaSemana++) {
          const cell = document.createElement('td');

          // Primeira semana - c√©lulas vazias antes do primeiro dia
          if (semanaAtual === 0 && diaDaSemana < diaDaSemanaInicial) {
            cell.classList.add('empty');
          }
          // Dias do m√™s
          else if (diaAtual <= diasNoMes) {
            const label = document.createElement('label');
            label.classList.add('day-checkbox');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = diaAtual;
            checkbox.id = 'day-' + diaAtual;

            // AJUSTADO: Verificar se o dia est√° nas folgas existentes
            const diaNumero = parseInt(diaAtual);
            const estaNoAppwrite = folgasExistentes.includes(diaNumero);
            checkbox.checked = estaNoAppwrite;

            // Se est√° marcado no Appwrite, adicionar ao estado
            if (estaNoAppwrite) {
              state.folgasSelecionadas.add(diaNumero);
            }

            // Event listener para mudan√ßas no checkbox
            checkbox.addEventListener('change', (event) => {
              const dia = parseInt(event.target.value);

              if (event.target.checked) {
                state.folgasSelecionadas.add(dia);
                console.log('Dia ' + dia + ' adicionado. Folgas atuais:', Array.from(state.folgasSelecionadas));
              } else {
                state.folgasSelecionadas.delete(dia);
                console.log('Dia ' + dia + ' removido. Folgas atuais:', Array.from(state.folgasSelecionadas));
              }
            });

            const labelText = document.createTextNode(diaAtual);

            label.appendChild(checkbox);
            label.appendChild(labelText);
            cell.appendChild(label);

            diaAtual++;
          }
          // C√©lulas vazias ap√≥s o √∫ltimo dia
          else {
            cell.classList.add('empty');
          }

          row.appendChild(cell);
        }

        elements.editableCalendarBody.appendChild(row);
        semanaAtual++;

        // Evita loop infinito
        if (semanaAtual > 6) break;
      }

      console.log('Calend√°rio edit√°vel criado para', mes, '/', ano);
      console.log('Folgas pr√©-selecionadas:', Array.from(state.folgasSelecionadas));

    } catch (error) {
      console.error('Erro ao criar calend√°rio edit√°vel:', error);
      alert('Erro ao criar calend√°rio: ' + error.message);
    }
  }

  // Valida√ß√£o de sele√ß√£o da primeira etapa
  function validateStep1() {
    state.pessoaSelecionada = Array.from(elements.pessoaRadios).find(r => r.checked)?.value || null;
    state.mesSelecionado = elements.monthSelect.value || null;
    state.anoSelecionado = elements.yearSelect.value || null;

    if (!state.pessoaSelecionada) {
      alert('Por favor, selecione a pessoa.');
      return false;
    }
    if (!state.mesSelecionado) {
      alert('Por favor, selecione o m√™s.');
      return false;
    }
    if (!state.anoSelecionado) {
      alert('Por favor, selecione o ano.');
      return false;
    }
    return true;
  }

  // Fun√ß√µes de callback para os eventos
  const handleNext = () => {
    if (validateStep1()) {
      renderStep2();
    }
  };

  // Attach global listeners durante modal aberta
  function attachListeners() {
    elements.closeBtn.addEventListener('click', closeModal);
    elements.cancelBtn.addEventListener('click', closeModal);
    elements.nextBtn.addEventListener('click', handleNext);
    elements.backBtn.addEventListener('click', renderStep1);
    elements.saveBtn.addEventListener('click', saveSchedule);
  
    // NOVO: Adicionar listeners para atualizar o texto do link de exclus√£o
    elements.monthSelect.addEventListener('change', updateDeleteLinkText);
    elements.yearSelect.addEventListener('change', updateDeleteLinkText);
    
    elements.deleteLink.addEventListener('click', handleDeleteSchedule);

  }

  // Remove listeners para evitar duplica√ß√£o
  function detachListeners() {
    elements.closeBtn.removeEventListener('click', closeModal);
    elements.cancelBtn.removeEventListener('click', closeModal);
    elements.nextBtn.removeEventListener('click', handleNext);
    elements.backBtn.removeEventListener('click', renderStep1);
    elements.saveBtn.removeEventListener('click', saveSchedule);
    
    // NOVO: Remover listeners do texto do link de exclus√£o
    elements.monthSelect.removeEventListener('change', updateDeleteLinkText);
    elements.yearSelect.removeEventListener('change', updateDeleteLinkText);
    
    elements.deleteLink.removeEventListener('click', handleDeleteSchedule);

  }

  // Simula√ß√£o de salvar a escala
  async function saveSchedule() {
    if (state.folgasSelecionadas.size === 0) {
      alert('Por favor, selecione pelo menos um dia de folga.');
      return Promise.reject('Nenhum dia selecionado');
    }
  
    const pessoa = state.pessoaSelecionada;
    const mes = state.mesSelecionado;
    const ano = state.anoSelecionado;
    
    if (!pessoa || !mes || !ano) {
      alert('Dados incompletos. Verifique pessoa, m√™s e ano.');
      return Promise.reject('Dados incompletos');
    }
  
    try {
      // Converte Set para Array de n√∫meros ordenados
      const folgas = Array.from(state.folgasSelecionadas).sort((a, b) => a - b);
      
      console.log('Salvando escala para:', { pessoa, mes, ano, folgas });
      console.log('Tipo dos dados das folgas:', folgas.map(f => typeof f));
  
      await saveScheduleAppwrite(pessoa, ano, mes, folgas);
      
      console.log('Escala salva com sucesso!');
      alert('Escala salva com sucesso!');
      
      closeModal();
      
      // Recarregar o calend√°rio para mostrar as mudan√ßas
      const monthSelect = document.getElementById('month-select');
      if (monthSelect.value) {
        const [yearStr, monthStr] = monthSelect.value.split('-');
        buildCalendar(parseInt(yearStr), parseInt(monthStr));
      }
      
      return Promise.resolve();
  
    } catch (error) {
      console.error('Erro ao salvar escala:', error);
	  alert('Erro ao salvar escala: ' + error.message);      throw error;
    }
  }
  return {
    openModal,
  };
})();

// Para abrir a edi√ß√£o de folgas
document.getElementById('add-schedule-btn').addEventListener('click', () => {
  FolgasEditor.openModal();
});
    </script>
  </body>
</html>
