<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escala de Trabalho - Mês Completo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .token {
      text-align: center;
      margin-bottom: 20px;
    }

    .token button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .token button:hover {
      background-color: #0056b3;
    }

    .token input {
      text-align: center;
      width: 700px;
      max-width: 90%;
      height: 25px;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls select {
      padding: 8px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .controls button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .controls button:hover {
      background-color: #0056b3;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .form-group textarea {
      height: 150px;
      resize: vertical;
    }

    .person-selection {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .person-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .person-option input[type="radio"] {
      width: auto;
    }

    .date-selection {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .date-selection select {
      flex: 1;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    table {
      width: 100%;
      max-width: 700px;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px 4px;
      vertical-align: top;
      word-wrap: break-word;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .weekend {
      background-color: #f8d7da;
      color: #721c24;
    }
    .workday {
      background-color: #d4edda;
      color: #155724;
    }
    .person-name {
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #d63384;
      background-color: #f8d7da;
      border: 1px solid #f5c2c7;
      border-radius: 4px;
      margin: 20px 0;
    }

    @media (max-width: 600px) {
      .modal-content {
        margin: 2% auto;
        width: 95%;
      }
      
      .person-selection {
        flex-direction: column;
        gap: 10px;
      }
      
      .date-selection {
        flex-direction: column;
      }
      
      table, thead, tbody, th, td, tr {
        display: block;
        width: 100%;
      }

      thead tr {
        display: none;
      }

      tbody tr {
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
      }

      tbody tr td {
        border: none;
        padding: 6px 10px;
        position: relative;
        text-align: left;
        background: none;
        color: inherit;
      }

      tbody tr td div:first-child {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 8px;
      }

      .person-name {
        display: inline-block;
        min-width: 80px;
      }
    }
  </style>
</head>
<body>

<h1>Escala de Trabalho</h1>

<div class="token">
  <input type="password" id="tokenInput" placeholder="Insira o token">
  <button onclick="usarToken()" id="executar-btn">Executar</button>
</div>

<div class="controls">
  <select id="month-select">
    <option value="">Carregando...</option>
  </select>
  <button id="add-schedule-btn">Adicionar Escala</button>
</div>

<div id="loading" class="loading" style="display: none;">Carregando dados...</div>
<div id="error" class="error" style="display: none;"></div>

<table>
  <thead>
    <tr>
      <th>Domingo</th>
      <th>Segunda</th>
      <th>Terça</th>
      <th>Quarta</th>
      <th>Quinta</th>
      <th>Sexta</th>
      <th>Sábado</th>
    </tr>
  </thead>
  <tbody id="calendar-body">
  </tbody>
</table>

<!-- Modal para adicionar escala -->
<div id="scheduleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Adicionar Escala</h2>
      <span class="close">&times;</span>
    </div>
    
    <div class="form-group">
      <label>Selecione a pessoa:</label>
      <div class="person-selection">
        <div class="person-option">
          <input type="radio" id="pessoa1" name="pessoa" value="Pessoa 1">
          <label for="pessoa1">Pessoa 1</label>
        </div>
        <div class="person-option">
          <input type="radio" id="pessoa2" name="pessoa" value="Pessoa 2">
          <label for="pessoa2">Pessoa 2</label>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Período da escala:</label>
      <div class="date-selection">
        <select id="schedule-month">
          <option value="">Selecione o mês</option>
        </select>
        <select id="schedule-year">
          <option value="">Selecione o ano</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="schedule-table">Cole a tabela de escala:</label>
      <textarea id="schedule-table" placeholder="Cole aqui a tabela HTML da escala..."></textarea>
    </div>

    <div class="modal-buttons">
      <button class="btn-secondary" id="cancel-btn">Cancelar</button>
      <button class="btn-primary" id="save-schedule-btn">Salvar Escala</button>
    </div>
  </div>
</div>

<script>
const gistId = 'b996dc535ebcc23c8b45f8979b4d86e0';
const filename = 'escalas_trabalho.json';
  
const people = ['Pessoa 1', 'Pessoa 2'];
const weekDayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
let currentMonth = null;
let currentYear = null;
let schedules = {}; // Armazena as escalas: {pessoa: {mesAno: [dias_folga]}}
let token = '';

function usarToken() {
  token = document.getElementById('tokenInput').value;
  if (token) {
    verificarToken()
    .then(tokenValido => {
      if (tokenValido) {
        loadSchedules();
        verificarTokenPeriodicamente();
      } else {
        showError('Token inválido. Por favor, verifique o token informado.');
      }
    });
  } else {
    showError('Por favor, informe o token.');
  }
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showError(message) {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

let tokenCheckIntervalId = null;

function verificarTokenPeriodicamente() {
  if (tokenCheckIntervalId) return;

  tokenCheckIntervalId = setInterval(async () => {
    try {
      const response = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (!response.ok) {
        mostrarMensagemTokenExpirado();
        clearInterval(tokenCheckIntervalId);
        tokenCheckIntervalId = null;
      }
    } catch (error) {
      console.error('Erro ao verificar token:', error);
    }
  }, 5 * 60 * 1000);
}

function mostrarMensagemTokenExpirado() {
  const mensagem = document.createElement('div');
  mensagem.textContent = 'Token expirado. Por favor, atualize o token.';
  mensagem.style.position = 'fixed';
  mensagem.style.top = '0';
  mensagem.style.left = '0';
  mensagem.style.width = '100%';
  mensagem.style.padding = '10px';
  mensagem.style.background = '#f8d7da';
  mensagem.style.color = '#721c24';
  mensagem.style.textAlign = 'center';
  mensagem.style.zIndex = '1000';

  document.body.appendChild(mensagem);

  setTimeout(() => {
    mensagem.remove();
  }, 5000);
}

function verificarToken() {
  return fetch('https://api.github.com/user', {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  })
  .then(response => response.ok)
  .catch(error => {
    console.error('Erro ao verificar token:', error);
    return false;
  });
}

function buildCalendar(year, month) {
  if (!token) {
    showError('Token não definido. Por favor, informe o token.');
    return;
  }
  
  const calendarBody = document.getElementById('calendar-body');
  calendarBody.innerHTML = '';

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const monthKey = `${getMonthName(month)} ${year}`;

  let date = 1;

  while (date <= lastDay.getDate()) {
    const row = document.createElement('tr');

    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
      const cell = document.createElement('td');

      if (date > lastDay.getDate()) {
        cell.innerHTML = '';
        row.appendChild(cell);
        continue;
      }

      if (date === 1 && dayOfWeek < firstDay.getDay()) {
        cell.innerHTML = '';
        row.appendChild(cell);
        continue;
      }

      const currentDate = new Date(year, month, date);
      const currentWeekDay = currentDate.getDay();

      let cellContent = `<div class="day-title">${date}</div>`;

      people.forEach(person => {
      let status = '';
      let className = 'workday';

      if (schedules[person] && schedules[person][monthKey]) {
        const dayOffList = schedules[person][monthKey];
        if (dayOffList.includes(date)) {
          status = 'Folga';
          className = 'weekend';
          cellContent += `<div class="${className}"><span class="person-name">${person}:</span> ${status}</div>`;
        }
      }
      
    });

      cell.innerHTML = cellContent;
      row.appendChild(cell);
      date++;
    }
    calendarBody.appendChild(row);
  }
}

function getMonthNumber(monthName) {
  const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  return monthNames.indexOf(monthName);
}

function getMonthName(monthNumber) {
  const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  return monthNames[monthNumber];
}

async function loadSchedules() {
  try {
    showLoading(true);
    
    const response = await fetch(`https://api.github.com/gists/${gistId}`);
    
    if (!response.ok) {
      throw new Error(`Erro ao carregar gist: ${response.status}`);
    }

    const gist = await response.json();
    const file = gist.files[filename];
    
    if (file && file.content.trim()) {
      try {
        schedules = JSON.parse(file.content);
      } catch (parseError) {
        console.error('Erro ao fazer parse das escalas:', parseError);
        schedules = {};
      }
    }

    updateMonthSelect();
    
    // Carrega o mês atual
    const date = new Date();
    const monthName = getMonthName(date.getMonth());
    const monthString = `${monthName} ${date.getFullYear()}`;
    loadMonth(monthString);

  } catch (error) {
    console.error('Erro ao carregar escalas:', error);
    showError('Erro ao carregar dados do servidor.');
    schedules = {};
    updateMonthSelect();
  } finally {
    showLoading(false);
  }
}

function updateMonthSelect() {
  const monthSelect = document.getElementById('month-select');
  monthSelect.innerHTML = '';
  
  // Cria uma lista de meses únicos das escalas
  const months = new Set();
  
  Object.values(schedules).forEach(personSchedules => {
    Object.keys(personSchedules).forEach(monthKey => {
      months.add(monthKey);
    });
  });
  
  // Adiciona o mês atual se não existir
  const date = new Date();
  const currentMonth = `${getMonthName(date.getMonth())} ${date.getFullYear()}`;
  months.add(currentMonth);
  
  // Ordena os meses
  const sortedMonths = Array.from(months).sort((a, b) => {
    const [monthA, yearA] = a.split(' ');
    const [monthB, yearB] = b.split(' ');
    const dateA = new Date(parseInt(yearA), getMonthNumber(monthA));
    const dateB = new Date(parseInt(yearB), getMonthNumber(monthB));
    return dateA - dateB;
  });
  
  sortedMonths.forEach(month => {
    const option = document.createElement('option');
    option.value = month;
    option.text = month;
    monthSelect.appendChild(option);
  });
  
  // Seleciona o mês atual
  monthSelect.value = currentMonth;
}

function loadMonth(month) {
  const [monthName, year] = month.split(' ');
  const monthNumber = getMonthNumber(monthName);
  
  if (monthNumber === -1) {
    showError('Formato de mês inválido');
    return;
  }
  
  currentMonth = monthNumber;
  currentYear = parseInt(year);
  
  buildCalendar(currentYear, currentMonth);
}

function parseScheduleTable(htmlTable) {
  try {
    // Cria um elemento temporário para fazer parse do HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlTable;
    
    const cells = tempDiv.querySelectorAll('td');
    const workDays = [];
    let previousDay = 0;
    
    cells.forEach(cell => {
      const text = cell.textContent || cell.innerText;
      
      // Extrai o número do dia da célula
      const dayMatch = text.match(/(\d{1,2})/);
      if (dayMatch) {
        const day = parseInt(dayMatch[1]);
        
        // Verifica se é um dia válido (1-31)
        if (day >= 1 && day <= 31) {
          // Se o dia é menor que o anterior, significa que é do mês anterior
          // e deve ser ignorado
          if (day < previousDay && previousDay > 15) {
            console.log(`Ignorando dia ${day} (provavelmente do mês anterior)`);
            return;
          }
          
          // Verifica se há horários de trabalho na célula
          const hasWorkSchedule = text.match(/\d{1,2}:\d{2}/);
          
          if (hasWorkSchedule) {
            // Se tem horário, é dia de trabalho
            workDays.push(day);
            console.log(`Dia ${day}: Trabalho (horários encontrados)`);
          } else {
            // Se não tem horário, é folga
            console.log(`Dia ${day}: Folga (sem horários)`);
          }
          
          previousDay = day;
        }
      }
    });
    
    console.log('Dias de trabalho extraídos:', workDays);
    return workDays;
    
  } catch (error) {
    console.error('Erro ao analisar tabela:', error);
    return [];
  }
}

function calculateDaysOff(workDays, year, month) {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const allDays = Array.from({length: daysInMonth}, (_, i) => i + 1);
  const daysOff = allDays.filter(day => !workDays.includes(day));
  
  console.log(`Mês ${month + 1}/${year}:`);
  console.log('Todos os dias:', allDays);
  console.log('Dias de trabalho:', workDays);
  console.log('Dias de folga:', daysOff);
  
  return daysOff;
}

async function saveSchedules() {
  try {
    const gistData = {
      files: {
        [filename]: {
          content: JSON.stringify(schedules, null, 2)
        }
      }
    };

    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(gistData)
    });
  
    if (!response.ok) {
      throw new Error('Erro ao salvar escalas no servidor');
    }
    
    console.log('Escalas salvas com sucesso!');
    
  } catch (error) {
    console.error('Erro ao salvar escalas:', error);
    showError('Erro ao salvar escalas no servidor.');
    throw error;
  }
}

// Funções do modal
function openScheduleModal() {
  const modal = document.getElementById('scheduleModal');
  
  // Popula os selects de mês e ano
  const monthSelect = document.getElementById('schedule-month');
  const yearSelect = document.getElementById('schedule-year');
  
  monthSelect.innerHTML = '<option value="">Selecione o mês</option>';
  yearSelect.innerHTML = '<option value="">Selecione o ano</option>';
  
  // Meses
  for (let i = 0; i < 12; i++) {
    const option = document.createElement('option');
    option.value = getMonthName(i);
    option.text = getMonthName(i);
    monthSelect.appendChild(option);
  }
  
  // Anos (atual e próximos 2 anos)
  const currentYear = new Date().getFullYear();
  for (let year = currentYear; year <= currentYear + 2; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.text = year;
    yearSelect.appendChild(option);
  }
  
  modal.style.display = 'block';
}

function closeScheduleModal() {
  const modal = document.getElementById('scheduleModal');
  modal.style.display = 'none';
  
  // Limpa o formulário
  document.querySelectorAll('input[name="pessoa"]').forEach(radio => radio.checked = false);
  document.getElementById('schedule-month').value = '';
  document.getElementById('schedule-year').value = '';
  document.getElementById('schedule-table').value = '';
}

async function saveSchedule() {
  try {
    const selectedPerson = document.querySelector('input[name="pessoa"]:checked');
    const selectedMonth = document.getElementById('schedule-month').value;
    const selectedYear = document.getElementById('schedule-year').value;
    const tableContent = document.getElementById('schedule-table').value.trim();
    
    if (!selectedPerson) {
      showError('Por favor, selecione uma pessoa.');
      return;
    }
    
    if (!selectedMonth || !selectedYear) {
      showError('Por favor, selecione o mês e ano.');
      return;
    }
    
    if (!tableContent) {
      showError('Por favor, cole a tabela de escala.');
      return;
    }
    
    const person = selectedPerson.value;
    const monthKey = `${selectedMonth} ${selectedYear}`;
    const monthNumber = getMonthNumber(selectedMonth);
    const year = parseInt(selectedYear);
    
    // Verifica se já existe escala para esta pessoa neste período
    if (schedules[person] && schedules[person][monthKey]) {
      if (!confirm(`Já existe uma escala para ${person} em ${monthKey}. Deseja substituir?`)) {
        return;
      }
    }
    
    // Analisa a tabela e extrai os dias de trabalho
    const workDays = parseScheduleTable(tableContent);
    
    if (workDays.length === 0) {
      showError('Não foi possível extrair os dias de trabalho da tabela. Verifique o formato.');
      return;
    }
    
    // Calcula os dias de folga
    const daysOff = calculateDaysOff(workDays, year, monthNumber);
    
    // Salva na estrutura de dados
    if (!schedules[person]) {
      schedules[person] = {};
    }
    
    schedules[person][monthKey] = daysOff;
    
    // Salva no gist
    await saveSchedules();
    
    // Atualiza a interface
    updateMonthSelect();
    loadMonth(monthKey);
    
    // Fecha o modal
    closeScheduleModal();
    
    showError(`Escala de ${person} para ${monthKey} salva com sucesso!`);
    
  } catch (error) {
    console.error('Erro ao salvar escala:', error);
    showError('Erro ao salvar a escala.');
  }
}

// Event listeners
document.getElementById('executar-btn').addEventListener('click', usarToken);
document.getElementById('add-schedule-btn').addEventListener('click', openScheduleModal);
document.getElementById('month-select').addEventListener('change', (e) => {
  if (e.target.value) {
    loadMonth(e.target.value);
  }
});

// Modal event listeners
document.querySelector('.close').addEventListener('click', closeScheduleModal);
document.getElementById('cancel-btn').addEventListener('click', closeScheduleModal);
document.getElementById('save-schedule-btn').addEventListener('click', saveSchedule);

// Fecha modal clicando fora dele
window.addEventListener('click', (e) => {
  const modal = document.getElementById('scheduleModal');
  if (e.target === modal) {
    closeScheduleModal();
  }
});

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
  // Não carrega automaticamente, espera o token ser informado
  const monthSelect = document.getElementById('month-select');
  monthSelect.innerHTML = '<option value="">Informe o token primeiro</option>';
});
</script>

</body>
</html>
